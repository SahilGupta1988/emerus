@page "/onboarding/my-contractors"
@attribute [Authorize(Roles = "Approver,Requestor")]

@using Emerus.ETM.Admin.Data

<PageTitle>My Contractors</PageTitle>

<div class="page-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
    <div>
        <h2 class="mb-0">My Contractors</h2>
        <p class="text-muted mb-0">Contractors submitted by your organization.</p>
    </div>
</div>

<div class="card">
    <div class="card-title-row px-3 py-2 border-bottom">
        <h5 class="mb-0">Contractor Requests</h5>
    </div>

    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="d-flex align-items-center gap-3">
            <small class="text-muted">Showing @PagedRows.Count() of @FilteredCount</small>

            <div class="btn-group btn-group-sm" role="group" aria-label="page size">
                <button class="btn btn-outline-secondary" @onclick="() => SetPageSize(10)" title="10 rows">10</button>
                <button class="btn btn-outline-secondary" @onclick="() => SetPageSize(20)" title="20 rows">20</button>
                <button class="btn btn-outline-secondary" @onclick="() => SetPageSize(30)" title="30 rows">30</button>
                <button class="btn btn-outline-secondary" @onclick="() => SetPageSize(50)" title="50 rows">50</button>
            </div>
        </div>

        <div class="d-flex gap-2 align-items-center">
            <div class="input-group input-group-sm">
                <span class="input-group-text">Search</span>
                <input class="form-control" placeholder="Contractor, vendor, facility or status" @bind="SearchText" @bind:event="oninput" />
            </div>

            <a class="btn btn-sm btn-primary btn-new-contractor" href="onboarding/new">New Contractor</a>
        </div>
    </div>

    <div class="card-body p-0 card-table-wrapper">
        <table class="table table-striped table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Contractor</th>
                    <th>Vendor</th>
                    <th>Facility</th>
                    <th>Start Date</th>
                    <th>Comments</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (!PagedRows.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center p-4">
                            <div class="text-muted">No matching requests found.</div>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var row in PagedRows)
                    {
                        <tr>
                            <td>@row.ContractorName</td>
                            <td>@row.VendorName</td>
                            <td>@row.Facility</td>
                            <td>@row.StartDate.ToShortDateString()</td>
                            <td title="@row.Comments" class="text-truncate" style="max-width:28ch;">@Truncate(row.Comments, 80)</td>
                            <td><span class="badge @GetStatusBadgeClass(row.Status)">@row.Status</span></td>
                            <td class="text-end">
                                @if (!IsFinalStatus(row.Status))
                                {
                                    @if (string.Equals(row.Status, "Draft", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => EditDraft(row.Id)">Edit</button>
                                    }
                                    else
                                    {
                                        @if (IsApprover)
                                        {
                                            <a href="onboarding/request/@row.Id" class="btn btn-sm btn-outline-secondary">View</a>
                                        }
                                    }
                                }
                                else
                                {
                                    <span class="text-muted small">No actions</span>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="card-footer d-flex justify-content-between align-items-center">
        <div>
            <small class="text-muted">Page @CurrentPage of @TotalPages</small>
        </div>

        <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" @onclick="PrevPage" disabled="@(CurrentPage == 1)">Previous</button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="NextPage" disabled="@(CurrentPage == TotalPages)">Next</button>
        </div>
    </div>
</div>

<style>
    .card-table-wrapper {
        max-height: 56vh;
        overflow: auto;
    }

    .badge {
        padding: .45rem .6rem;
        font-size: .85rem;
    }

    .btn-new-contractor {
        min-width: 140px;
        white-space: nowrap;
    }

    .table tbody tr {
        transition: background-color .12s ease;
    }

    .table.table-hover tbody tr:hover > td,
    .table.table-hover tbody tr:hover > th {
        background-color: rgba(13,110,253,0.06);
    }

    td.text-truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>
