@using Emerus.ETM.Admin.Data
@using Emerus.ETM.Admin.Pages
@using System.Data
@using System.Data.Common
@using System.Linq
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db

<div class="card-section">
    <h5>Access Requests</h5>
    <p class="text-muted">Select the RBAC groups or application roles needed. This is mocked data for UI layout only.</p>

    <div class="row">
        <div class="col-md-5">
            <label class="form-label">Available Targets</label>
            <select class="form-select" multiple style="min-height: 200px" @onchange="OnAdd">
                @foreach (var target in AvailableTargets)
                {
                    <option value="@target.TargetId">@target.DisplayName</option>
                }
            </select>
        </div>
        <div class="col-md-2 d-flex align-items-center justify-content-center">
            <span class="text-muted">Selected</span>
        </div>
        <div class="col-md-5">
            <label class="form-label">Requested Targets</label>
            <ul class="list-group">
                @foreach (var rt in Model.RequestedTargets)
                {
                    var display = AvailableTargets.FirstOrDefault(a => a.TargetId == rt.TargetId)?.DisplayName ?? rt.TargetId.ToString();
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>@display</span>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => Remove(rt.TargetId)">Remove</button>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public OnboardingNew.AccessModel Model { get; set; } = default!;

    private List<TargetCatalogModel> AvailableTargets { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableTargetsAsync();
    }

    private async Task LoadAvailableTargetsAsync()
    {
        DbConnection? conn = null;
        try
        {
            conn = Db.Database.GetDbConnection();
            await conn.OpenAsync();

            using var cmd = conn.CreateCommand();
            // Query full rows (TargetId + DisplayName) from iam.TargetCatalog; restrict to active rows
            cmd.CommandText = "SELECT TargetId, DisplayName FROM iam.TargetCatalog WHERE IsActive = 1 ORDER BY DisplayName";
            using var reader = await cmd.ExecuteReaderAsync();

            var list = new List<TargetCatalogModel>();
            while (await reader.ReadAsync())
            {
                var item = new TargetCatalogModel();

                if (!reader.IsDBNull(0))
                {
                    item.TargetId = reader.GetGuid(0);
                }

                if (!reader.IsDBNull(1))
                {
                    item.DisplayName = reader.GetString(1);
                }

                list.Add(item);
            }

            AvailableTargets = list;
        }
        catch (Exception)
        {
            // If DB call fails, do NOT populate sample values — leave the list empty so UI shows nothing
            AvailableTargets = new List<TargetCatalogModel>();
        }
        finally
        {
            if (conn is not null && conn.State == ConnectionState.Open)
            {
                await conn.CloseAsync();
            }

            StateHasChanged();
        }
    }

    private void OnAdd(ChangeEventArgs e)
    {
        // For mockup purposes, add all available targets as RequestTargetModel entries if not already present.
        foreach (var t in AvailableTargets)
        {
            if (!Model.RequestedTargets.Any(r => r.TargetId == t.TargetId))
            {
                Model.RequestedTargets.Add(new OnboardingNew.RequestTargetModel
                {
                    AccessRequestId = Guid.NewGuid(),
                    RequestId = Guid.Empty,
                    TargetId = t.TargetId
                });
            }
        }
    }

    private void Remove(Guid targetId)
    {
        var existing = Model.RequestedTargets.FirstOrDefault(r => r.TargetId == targetId);
        if (existing is not null)
        {
            Model.RequestedTargets.Remove(existing);
        }
    }

    public class TargetCatalogModel
    {
        public Guid TargetId { get; set; }
        public string DisplayName { get; set; } = string.Empty;
    }
}
