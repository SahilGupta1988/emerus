@using Emerus.ETM.Admin.Data
@using Emerus.ETM.Admin.Pages
@using System.Data
@using System.Data.Common
@using System.Linq
@using Microsoft.EntityFrameworkCore
@inject AppDbContext Db

<div class="card-section">
    <h5>Access Requests</h5>
    <p class="text-muted">Select the RBAC groups or application roles needed. This is mocked data for UI layout only.</p>

    <div class="row">
        <div class="col-md-5">
            <label class="form-label">Available Targets</label>

            <div class="input-group mb-2">
                <input class="form-control form-control-sm" placeholder="Filter..." @bind="FilterText" />
                <button class="btn btn-sm btn-outline-secondary" type="button" @onclick="ClearFilter">Clear</button>
            </div>

            <ul class="list-group" style="min-height: 200px; max-height: 320px; overflow:auto;">
                @foreach (var target in FilteredAvailableTargets)
                {
                    var isSelected = SelectedAvailableTargets.Contains(target.TargetId);
                    <li class="list-group-item d-flex justify-content-between align-items-center @(isSelected ? "active" : "")"
                        role="button"
                        @onclick="() => ToggleAvailableSelection(target.TargetId)"
                        aria-pressed="@(isSelected)">
                        <span>@target.DisplayName</span>
                        <small class="text-muted">@target.TargetId.ToString()</small>
                    </li>
                }
            </ul>
        </div>

        <div class="col-md-2 d-flex flex-column align-items-center justify-content-center">
            <div class="d-grid gap-2 w-100">
                <button class="btn btn-sm btn-primary" @onclick="AddSelected" title="Add selected">Add →</button>
                <button class="btn btn-sm btn-outline-primary" @onclick="AddAll" title="Add all">Add all →</button>
                <button class="btn btn-sm btn-outline-danger" @onclick="RemoveSelected" title="Remove selected">← Remove</button>
                <button class="btn btn-sm btn-danger" @onclick="RemoveAll" title="Remove all">← Remove all</button>
            </div>
        </div>

        <div class="col-md-5">
            <label class="form-label">Requested Targets</label>

            <ul class="list-group" style="min-height: 200px; max-height: 320px; overflow:auto;">
                @foreach (var rt in Model.RequestedTargets)
                {
                    var display = AvailableTargets.FirstOrDefault(a => a.TargetId == rt.TargetId)?.DisplayName ?? rt.TargetId.ToString();
                    var isSel = SelectedRequestedTargets.Contains(rt.TargetId);
                    <li class="list-group-item d-flex justify-content-between align-items-center @(isSel ? "active" : "")"
                        role="button"
                        @onclick="() => ToggleRequestedSelection(rt.TargetId)"
                        aria-pressed="@(isSel)">
                        <span>@display</span>
                        <small class="text-muted">@rt.TargetId.ToString()</small>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public OnboardingNew.AccessModel Model { get; set; } = default!;

    private List<TargetCatalogModel> AvailableTargets { get; set; } = new();

    private HashSet<Guid> SelectedAvailableTargets { get; } = new();
    private HashSet<Guid> SelectedRequestedTargets { get; } = new();

    private string FilterText { get; set; } = string.Empty;
    private IEnumerable<TargetCatalogModel> FilteredAvailableTargets =>
        string.IsNullOrWhiteSpace(FilterText)
            ? AvailableTargets
            : AvailableTargets.Where(t => t.DisplayName.Contains(FilterText, StringComparison.OrdinalIgnoreCase) || t.TargetId.ToString().Contains(FilterText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadAvailableTargetsAsync();
    }

    private async Task LoadAvailableTargetsAsync()
    {
        DbConnection? conn = null;
        try
        {
            conn = Db.Database.GetDbConnection();
            await conn.OpenAsync();

            using var cmd = conn.CreateCommand();
            // Query full rows (TargetId + DisplayName) from iam.TargetCatalog; restrict to active rows
            cmd.CommandText = "SELECT TargetId, DisplayName FROM iam.TargetCatalog WHERE IsActive = 1 ORDER BY DisplayName";
            using var reader = await cmd.ExecuteReaderAsync();

            var list = new List<TargetCatalogModel>();
            while (await reader.ReadAsync())
            {
                var item = new TargetCatalogModel();

                if (!reader.IsDBNull(0))
                {
                    item.TargetId = reader.GetGuid(0);
                }

                if (!reader.IsDBNull(1))
                {
                    item.DisplayName = reader.GetString(1);
                }

                list.Add(item);
            }

            AvailableTargets = list;
        }
        catch (Exception)
        {
            // If DB call fails, do NOT populate sample values — leave the list empty so UI shows nothing
            AvailableTargets = new List<TargetCatalogModel>();
        }
        finally
        {
            if (conn is not null && conn.State == ConnectionState.Open)
            {
                await conn.CloseAsync();
            }

            StateHasChanged();
        }
    }

    private void ToggleAvailableSelection(Guid id)
    {
        if (!SelectedAvailableTargets.Remove(id))
        {
            SelectedAvailableTargets.Add(id);
        }
    }

    private void ToggleRequestedSelection(Guid id)
    {
        if (!SelectedRequestedTargets.Remove(id))
        {
            SelectedRequestedTargets.Add(id);
        }
    }

    private void AddSelected()
    {
        foreach (var id in SelectedAvailableTargets.ToList())
        {
            if (!Model.RequestedTargets.Any(r => r.TargetId == id))
            {
                Model.RequestedTargets.Add(new OnboardingNew.RequestTargetModel
                {
                    AccessRequestId = Guid.NewGuid(),
                    RequestId = Guid.Empty,
                    TargetId = id
                });
            }
            SelectedAvailableTargets.Remove(id);
        }
        StateHasChanged();
    }

    private void AddAll()
    {
        foreach (var t in AvailableTargets)
        {
            if (!Model.RequestedTargets.Any(r => r.TargetId == t.TargetId))
            {
                Model.RequestedTargets.Add(new OnboardingNew.RequestTargetModel
                {
                    AccessRequestId = Guid.NewGuid(),
                    RequestId = Guid.Empty,
                    TargetId = t.TargetId
                });
            }
        }
        SelectedAvailableTargets.Clear();
        StateHasChanged();
    }

    private void RemoveSelected()
    {
        foreach (var id in SelectedRequestedTargets.ToList())
        {
            var existing = Model.RequestedTargets.FirstOrDefault(r => r.TargetId == id);
            if (existing is not null)
            {
                Model.RequestedTargets.Remove(existing);
            }
            SelectedRequestedTargets.Remove(id);
        }
        StateHasChanged();
    }

    private void RemoveAll()
    {
        Model.RequestedTargets.Clear();
        SelectedRequestedTargets.Clear();
        StateHasChanged();
    }

    private void ClearFilter() => FilterText = string.Empty;

    public class TargetCatalogModel
    {
        public Guid TargetId { get; set; }
        public string DisplayName { get; set; } = string.Empty;
    }
}
