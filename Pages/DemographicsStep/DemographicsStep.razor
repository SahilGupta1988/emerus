@using Emerus.ETM.Admin.Data
@attribute [Authorize(Roles = "Approver,Requestor")]

@using Emerus.ETM.Admin.Pages
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Components.Forms
@using System.Linq

<style>
    /* make field-level validation messages obvious and consistent */
    .field-validation {
        color: #dc3545; /* Bootstrap danger red */
        font-size: .875rem;
        margin-top: .25rem;
        display: block;
    }

    /* summary uses Bootstrap alert for strong visual feedback */
    .validation-summary {
        margin-bottom: 1rem;
    }

    /* small red asterisk spacing */
    .required-asterisk {
        color: #dc3545;
        margin-left: .25rem;
    }
</style>

<div class="card-section">
    <h5>Demographics</h5>

    <EditForm EditContext="editContext" OnValidSubmit="OnValidSubmit">
        <DataAnnotationsValidator />

        <!-- Name group -->
        <div class="row g-3 mt-2">
            <div class="col-md-6">
                <label class="form-label">First Name<span class="required-asterisk">*</span></label>
                <InputText class="form-control" @bind-Value="Model.FirstName" />
                <ValidationMessage For="@(() => Model.FirstName)" class="field-validation" />
            </div>

            <div class="col-md-6">
                <label class="form-label">Last Name<span class="required-asterisk">*</span></label>
                <InputText class="form-control" @bind-Value="Model.LastName" />
                <ValidationMessage For="@(() => Model.LastName)" class="field-validation" />
            </div>
        </div>

        <div class="row g-3 mt-2">
            <div class="col-md-6">
                <label class="form-label">Preferred First Name</label>
                <InputText class="form-control" @bind-Value="Model.PreferredFirstName" />
                <ValidationMessage For="@(() => Model.PreferredFirstName)" class="field-validation" />
            </div>

            <div class="col-md-6">
                <label class="form-label">Preferred Last Name</label>
                <InputText class="form-control" @bind-Value="Model.PreferredLastName" />
                <ValidationMessage For="@(() => Model.PreferredLastName)" class="field-validation" />
            </div>
        </div>

        <!-- Identity / DOB / Gender -->
        <div class="row g-3 mt-3">
            <div class="col-md-4">
                <label class="form-label">Date of Birth<span class="required-asterisk">*</span></label>
                <InputDate class="form-control" @bind-Value="Model.DateOfBirth" />
                <ValidationMessage For="@(() => Model.DateOfBirth)" class="field-validation" />
            </div>

            <div class="col-md-4">
                <label class="form-label">Gender</label>
                <InputSelect class="form-select" @bind-Value="Model.Gender">
                    <option value="">Select gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </InputSelect>
                <ValidationMessage For="@(() => Model.Gender)" class="field-validation" />
            </div>

            <div class="col-md-4">
                <label class="form-label">Identity</label>
                <InputSelect class="form-select" @bind-Value="Model.Identity">
                    <option value="">Select identity</option>
                    <option value="SsnLast4">SsnLast4</option>
                    <option value="FullSsnEncrypted">FullSsnEncrypted</option>
                </InputSelect>
                <ValidationMessage For="@(() => Model.Identity)" class="field-validation" />
            </div>
        </div>

        <!-- Contact group -->
        <div class="row g-3 mt-3">
            <div class="col-md-6">
                <label class="form-label">Personal Email<span class="required-asterisk">*</span></label>
                <InputText class="form-control" @bind-Value="Model.PersonalEmail" type="email" />
                <ValidationMessage For="@(() => Model.PersonalEmail)" class="field-validation" />
            </div>

            <div class="col-md-6">
                <label class="form-label">Cell Phone</label>
                <InputText class="form-control" @bind-Value="Model.CellPhone" type="tel" />
                <ValidationMessage For="@(() => Model.CellPhone)" class="field-validation" />
            </div>
        </div>

        <!-- Address block -->
        <div class="row g-3 mt-3">
            <div class="col-6">
                <label class="form-label">Address Line 1</label>
                <InputText class="form-control" @bind-Value="Model.AddressLine1" />
                <ValidationMessage For="@(() => Model.AddressLine1)" class="field-validation" />
            </div>
            <div class="col-6">
                <label class="form-label">Address Line 2</label>
                <InputText class="form-control" @bind-Value="Model.AddressLine2" />
                <ValidationMessage For="@(() => Model.AddressLine2)" class="field-validation" />
            </div>
        </div>

        <div class="row g-3 mt-2">
            <div class="col-md-5">
                <label class="form-label">City<span class="required-asterisk">*</span></label>
                <InputText class="form-control" @bind-Value="Model.City" />
                <ValidationMessage For="@(() => Model.City)" class="field-validation" />
            </div>

            <div class="col-md-4">
                <label class="form-label">State<span class="required-asterisk">*</span></label>
                <InputText class="form-control" @bind-Value="Model.StateProvince" />
                <ValidationMessage For="@(() => Model.StateProvince)" class="field-validation" />
            </div>

            <div class="col-md-3">
                <label class="form-label">Postal</label>
                <InputText class="form-control" @bind-Value="Model.PostalCode" />
                <ValidationMessage For="@(() => Model.PostalCode)" class="field-validation" />
            </div>
        </div>

        <div class="row g-3 mt-3">
            <div class="col-md-4">
                <label class="form-label">Country<span class="required-asterisk">*</span></label>
                <InputText class="form-control" @bind-Value="Model.CountryCode" maxlength="2" />
                <ValidationMessage For="@(() => Model.CountryCode)" class="field-validation" />
            </div>
        </div>
    </EditForm>
</div>

@code {
    // [Parameter]
    // public OnboardingNew.DemographicsModel Model { get; set; } = default!;

    private EditContext? editContext;
    private ValidationMessageStore? messageStore;
    private EventHandler<FieldChangedEventArgs>? fieldChangedHandler;

    protected override void OnParametersSet()
    {
        if (Model is null)
        {
            Model = new OnboardingNew.DemographicsModel();
        }

        // Recreate EditContext and message store when the model instance changes (edit mode / parent provides model later)
        if (editContext is null || !ReferenceEquals(editContext.Model, Model))
        {
            // Unsubscribe previous handler if present
            if (editContext is not null && fieldChangedHandler is not null)
            {
                editContext.OnFieldChanged -= fieldChangedHandler;
            }

            editContext = new EditContext(Model);
            messageStore = new ValidationMessageStore(editContext);

            fieldChangedHandler = (_, __) => ValidateModel();
            editContext.OnFieldChanged += fieldChangedHandler;

            ValidateModel();
        }
    }

    private void OnValidSubmit()
    {
        // placeholder - submission handled by parent flow
    }

    private void ValidateModel()
        {
        if (editContext is null || messageStore is null) return;

        // Clear only messages added via this messageStore
        messageStore.Clear();

        // Run registered validators (DataAnnotationsValidator) so their messages appear first
        // This prevents us from adding duplicate messages when attributes like [Required] are present.
        editContext.Validate();

        bool HasMessages(string fieldName)
        {
            var field = editContext.Field(fieldName);
            return editContext.GetValidationMessages(field).Any();
        }

        // Required fields - add custom message only if no existing messages for that field
        var firstNameField = editContext.Field(nameof(Model.FirstName));
        if (!HasMessages(nameof(Model.FirstName)) && string.IsNullOrWhiteSpace(Model.FirstName))
        {
            messageStore.Add(firstNameField, "First name is required.");
        }

        var lastNameField = editContext.Field(nameof(Model.LastName));
        if (!HasMessages(nameof(Model.LastName)) && string.IsNullOrWhiteSpace(Model.LastName))
        {
            messageStore.Add(lastNameField, "Last name is required.");
        }

        var emailField = editContext.Field(nameof(Model.PersonalEmail));
        if (!HasMessages(nameof(Model.PersonalEmail)))
        {
            if (string.IsNullOrWhiteSpace(Model.PersonalEmail))
            {
                messageStore.Add(emailField, "Personal email is required.");
            }
            else
            {
                try
                {
                    var addr = new System.Net.Mail.MailAddress(Model.PersonalEmail);
                    if (addr.Address != Model.PersonalEmail)
                    {
                        messageStore.Add(emailField, "Email address is invalid.");
                    }
                }
                catch
                {
                    messageStore.Add(emailField, "Email address is invalid.");
                }
            }
        }

        var dobField = editContext.Field(nameof(Model.DateOfBirth));
        if (!HasMessages(nameof(Model.DateOfBirth)))
        {
            if (Model.DateOfBirth == default)
            {
                messageStore.Add(dobField, "Date of birth is required.");
            }
            else if (Model.DateOfBirth > DateTime.Today)
            {
                messageStore.Add(dobField, "Date of birth cannot be in the future.");
            }
        }

        var cityField = editContext.Field(nameof(Model.City));
        if (!HasMessages(nameof(Model.City)) && string.IsNullOrWhiteSpace(Model.City))
        {
            messageStore.Add(cityField, "City is required.");
        }

        var stateField = editContext.Field(nameof(Model.StateProvince));
        if (!HasMessages(nameof(Model.StateProvince)) && string.IsNullOrWhiteSpace(Model.StateProvince))
        {
            messageStore.Add(stateField, "State is required.");
        }

        var countryField = editContext.Field(nameof(Model.CountryCode));
        if (!HasMessages(nameof(Model.CountryCode)))
        {
            if (string.IsNullOrWhiteSpace(Model.CountryCode))
            {
                messageStore.Add(countryField, "Country is required.");
            }
            else if (Model.CountryCode.Length > 2)
            {
                messageStore.Add(countryField, "Country must be at most 2 characters (ISO code).");
            }
        }

        editContext.NotifyValidationStateChanged();
    }

    public void Dispose()
    {
        if (editContext is not null && fieldChangedHandler is not null)
        {
            editContext.OnFieldChanged -= fieldChangedHandler;
        }
    }
}