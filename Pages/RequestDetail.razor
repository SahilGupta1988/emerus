@page "/onboarding/request/{requestId:guid}"
@using Emerus.ETM.Admin.Data
@using Microsoft.EntityFrameworkCore
@using System.Linq
@using System.Data.Common
@using System.Data
@inject AppDbContext Db
@inject NavigationManager Navigation
@inject IJSRuntime JS

@if (IsLoading)
{
    <div class="d-flex justify-content-center my-5">
        <div class="spinner-border" role="status" aria-hidden="true"></div>
        <span class="ms-3">Loading request...</span>
    </div>
}
else if (IsNotFound)
{
    <div class="alert alert-warning">Request not found.</div>
}
else
{
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Navigation.BaseUri">Home</a></li>
            <li class="breadcrumb-item active" aria-current="page">RequestDetail</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
            <h4 class="mb-0">@DisplayName</h4>
            <div class="text-muted">@VendorName</div>
        </div>
        <div class="text-end">
            <div>
                <span class="badge @StatusBadgeClass">@StatusText</span>
            </div>
            <small class="text-muted">Created: @CreatedAt.ToLocalTime().ToString("g")</small>
            @if (SubmittedAt is not null)
            {
                <div><small class="text-muted">Submitted: @SubmittedAt.Value.ToLocalTime().ToString("g")</small></div>
            }

            <div class="mt-2">
                <button class="btn btn-success btn-sm me-1" @onclick="ApproveRequest" disabled="@IsLoading">Approve</button>
                <button class="btn btn-danger btn-sm me-1" @onclick="RejectRequest" disabled="@IsLoading">Reject</button>
                <button class="btn btn-warning btn-sm" @onclick="ReturnRequest" disabled="@IsLoading">Return</button>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-md-4">
            <div class="card mb-3">
                <div class="card-header">
                    Summary
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-5 text-muted">Facility</dt>
                        <dd class="col-7">@Badge.PrimaryFacility</dd>

                        <dt class="col-5 text-muted">Request Type</dt>
                        <dd class="col-7">@Badge.RequestType</dd>

                        <dt class="col-5 text-muted">Start Date</dt>
                        <dd class="col-7">@((JobInfo.StartDate != default) ? JobInfo.StartDate.ToShortDateString() : "-")</dd>

                        <dt class="col-5 text-muted">Contact</dt>
                        <dd class="col-7">@Demographics.PersonalEmail</dd>
                    </dl>
                </div>
                <div class="card-footer d-flex justify-content-between">
                    <div>
                        <button class="btn btn-outline-secondary btn-sm" @onclick="GoBack">Back</button>
                    </div>
                    <div>
                        <button class="btn btn-light btn-sm" @onclick="Print">Print</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Access Requested</div>
                <div class="card-body p-0">
                    @if (AccessInfo.RequestedTargets is null || !AccessInfo.RequestedTargets.Any())
                    {
                        <div class="p-3 text-muted">No access requested.</div>
                    }
                    else
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var t in AccessInfo.RequestedTargets)
                            {
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-semibold">@(TargetCatalog?.FirstOrDefault(tc => tc.TargetId == t.TargetId)?.DisplayName ?? t.TargetId.ToString())</div>
                                        <small class="text-muted">@t.Environment @if(!string.IsNullOrWhiteSpace(t.ChangeType)){ <span> · @t.ChangeType</span> }</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-secondary">@t.CreatedAt.ToLocalTime().ToString("d")</span>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-header">Demographics</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="mb-1">@Demographics.PreferredFirstName @Demographics.PreferredLastName</h6>
                            <div class="text-muted">(@Demographics.FirstName @Demographics.LastName)</div>
                            <hr />
                            <div><strong>Email</strong>: @Demographics.PersonalEmail</div>
                            <div><strong>Phone</strong>: @Demographics.CellPhone</div>
                        </div>
                        <div class="col-md-6">
                            <div><strong>DOB</strong>: @((Demographics.DateOfBirth != default) ? Demographics.DateOfBirth.ToShortDateString() : "-")</div>
                            <div><strong>Gender</strong>: @Demographics.Gender</div>
                            <div><strong>Address</strong>:</div>
                            <div class="text-muted">@Demographics.AddressLine1</div>
                            @if (!string.IsNullOrWhiteSpace(Demographics.AddressLine2))
                            {
                                <div class="text-muted">@Demographics.AddressLine2</div>
                            }
                            <div class="text-muted">@Demographics.City, @Demographics.StateProvince @Demographics.PostalCode</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Job & Dates</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div><strong>Job title</strong>: @JobInfo.JobTitle</div>
                            <div><strong>Department</strong>: @JobInfo.Department</div>
                            <div><strong>Agency</strong>: @JobInfo.AgencyName</div>
                        </div>
                        <div class="col-md-6">
                            <div><strong>External ID</strong>: @JobInfo.ExternalEmployeeId</div>
                            <div><strong>Prior Employee</strong>: @((JobInfo.PriorEmployeeFlag) ? "Yes" : "No")</div>
                            <div><strong>Start date</strong>: @((JobInfo.StartDate != default) ? JobInfo.StartDate.ToShortDateString() : "-")</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-header">Hardware</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4"><strong>Laptop</strong>: @((Hardware.NeedsLaptop) ? "Yes" : "No")</div>
                        <div class="col-md-4"><strong>Dock</strong>: @((Hardware.NeedsDock) ? "Yes" : "No")</div>
                        <div class="col-md-4"><strong>Monitors</strong>: @Hardware.MonitorCount</div>
                    </div>
                    <div class="mt-3"><strong>Notes</strong>: @(!string.IsNullOrWhiteSpace(Hardware.Notes) ? Hardware.Notes : "None")</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Badge</div>
                <div class="card-body">
                    <div><strong>Requested</strong>: @((Badge.NeedsBadge) ? "Yes" : "No")</div>
                    <div><strong>Facility</strong>: @Badge.PrimaryFacility</div>
                    <div><strong>Access level</strong>: @Badge.RequestType</div>
                </div>
            </div>
        </div>
    </div>
}

@code {



    [Parameter]
    public Guid requestId { get; set; }

    private bool IsNotFound { get; set; }
    private bool IsLoading { get; set; }

    // display models
    private OnboardingNew.DemographicsModel Demographics { get; set; } = new();
    private OnboardingNew.JobModel JobInfo { get; set; } = new();
    private OnboardingNew.AccessModel AccessInfo { get; set; } = new();
    private List<AccessStep.TargetCatalogModel> TargetCatalog { get; set; } = new();
    private OnboardingNew.HardwareModel Hardware { get; set; } = new();
    private OnboardingNew.BadgeModel Badge { get; set; } = new();

    // additional display fields
    private string VendorName { get; set; } = string.Empty;
    private string DisplayName { get; set; } = string.Empty;
    private string StatusText { get; set; } = string.Empty;
    private string StatusBadgeClass { get; set; } = "bg-secondary";
    private DateTime CreatedAt { get; set; }
    private DateTime? SubmittedAt { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        IsLoading = true;
        IsNotFound = false;

        try
        {
            var request = await Db.ContractorRequests
                .Include(r => r.ContractorPerson)
                .Include(r => r.ContractorHardwareRequest)
                .Include(r => r.Partner)
                .FirstOrDefaultAsync(r => r.RequestId == requestId);

            if (request is null)
            {
                IsNotFound = true;
                return;
            }

            var person = request.ContractorPerson;
            var hardware = request.ContractorHardwareRequest;

            Demographics = new OnboardingNew.DemographicsModel
            {
                FirstName = person?.FirstName ?? string.Empty,
                PreferredFirstName = person?.PreferredFirstName ?? string.Empty,
                LastName = person?.LastName ?? string.Empty,
                PreferredLastName = person?.PreferredLastName ?? string.Empty,
                PersonalEmail = person?.PersonalEmail ?? string.Empty,
                CellPhone = person?.CellPhone ?? string.Empty,
                DateOfBirth = person?.DateOfBirth ?? default,
                Gender = person?.Gender ?? string.Empty,
                AddressLine1 = person?.AddressLine1 ?? string.Empty,
                AddressLine2 = person?.AddressLine2 ?? string.Empty,
                City = person?.City ?? string.Empty,
                StateProvince = person?.StateProvince ?? string.Empty,
                PostalCode = person?.PostalCode ?? string.Empty,
                CountryCode = person?.CountryCode ?? string.Empty,
                Identity = string.Empty
            };

            JobInfo = new OnboardingNew.JobModel
            {
                AgencyName = person?.AgencyName ?? string.Empty,
                JobTitle = person?.JobTitle ?? string.Empty,
                JobCode = person?.JobCode ?? string.Empty,
                Department = person?.Department ?? string.Empty,
                ExternalEmployeeId = person?.ExternalEmployeeId ?? string.Empty,
                PriorEmployeeFlag = person?.PriorEmployeeFlag ?? false,
                StartDate = person?.StartDate ?? default
            };

            AccessInfo = new OnboardingNew.AccessModel
            {
                RequestedTargets = await Db.ContractorAccessRequest
                    .Where(a => a.RequestId == requestId)
                    .Select(a => new OnboardingNew.RequestTargetModel
                    {
                        AccessRequestId = a.AccessRequestId,
                        RequestId = a.RequestId,
                        TargetId = a.TargetId,
                        Environment = a.Environment,
                        ChangeType = a.ChangeType,
                        MirrorUserUpn = a.MirrorUserUpn,
                        DetailJson = a.DetailJson,
                        CreatedAt = a.CreatedAt,
                        CreatedByUpn = a.CreatedByUpn
                    }).ToListAsync()
            };

            Hardware = new OnboardingNew.HardwareModel
            {
                NeedsLaptop = hardware?.NeedsLaptop ?? false,
                NeedsDock = hardware?.NeedsDock ?? false,
                MonitorCount = hardware?.MonitorCount ?? 0,
                NeedsHeadset = hardware?.NeedsHeadset ?? false,
                NeedsHotspot = hardware?.NeedsHotspot ?? false,
                Notes = hardware?.Notes ?? string.Empty
            };

            Badge = new OnboardingNew.BadgeModel
            {
                NeedsBadge = !string.IsNullOrWhiteSpace(request.RequestType),
                PrimaryFacility = request.PrimaryFacility ?? string.Empty,
                RequestType = request.RequestType ?? string.Empty
            };

            // Display metadata
            VendorName = request.Partner?.DisplayName ?? string.Empty;
            DisplayName = string.IsNullOrWhiteSpace(Demographics.PreferredFirstName) ? $"{Demographics.FirstName} {Demographics.LastName}".Trim() : $"{Demographics.PreferredFirstName} {Demographics.PreferredLastName}".Trim();
            StatusText = request.Status ?? string.Empty;
            StatusBadgeClass = request.Status switch
            {
                "Submitted" => "bg-success",
                "In Progress" => "bg-info",
                "Draft" => "bg-secondary",
                "Completed" => "bg-primary",
                "Cancelled" => "bg-danger",
                "Returned" => "bg-warning",
                _ => "bg-secondary"
            };
            CreatedAt = request.CreatedAt;
            SubmittedAt = request.SubmittedAt;

            // Load TargetCatalog from iam.TargetCatalog table
            var list = new List<AccessStep.TargetCatalogModel>();
            DbConnection? conn = null;
            try
            {
                conn = Db.Database.GetDbConnection();
                await conn.OpenAsync();

                using var cmd = conn.CreateCommand();
                cmd.CommandText = "SELECT TargetId, DisplayName FROM iam.TargetCatalog WHERE IsActive = 1 ORDER BY DisplayName";
                using var reader = await cmd.ExecuteReaderAsync();

                while (await reader.ReadAsync())
                {
                    var item = new AccessStep.TargetCatalogModel();

                    if (!reader.IsDBNull(0))
                    {
                        item.TargetId = reader.GetGuid(0);
                    }

                    if (!reader.IsDBNull(1))
                    {
                        item.DisplayName = reader.GetString(1);
                    }

                    list.Add(item);
                }

                TargetCatalog = list;
            }
            catch
            {
                TargetCatalog = new List<AccessStep.TargetCatalogModel>();
            }
            finally
            {
                if (conn is not null && conn.State == ConnectionState.Open)
                {
                    await conn.CloseAsync();
                }
            }
        }
        finally
        {
            IsLoading = false;
        }
    }

    void GoBack()
    {
        Navigation.NavigateTo("/");
    }

    void EditRequest()
    {
        // navigate to the onboarding new page that can edit based on id (adjust route if you implemented edit route)
        Navigation.NavigateTo($"/onboarding/new?editId={requestId}");
    }

    async Task Print()
    {
        try
        {
            await JS.InvokeVoidAsync("print");
        }
        catch
        {
            // ignore
        }
    }

    private async Task ApproveRequest()
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Approve this request?");
        if (!confirmed) return;

        IsLoading = true;
        try
        {
            var req = await Db.ContractorRequests.FirstOrDefaultAsync(r => r.RequestId == requestId);
            if (req is null)
            {
                await JS.InvokeVoidAsync("alert", "Request not found.");
                return;
            }

            req.Status = "Approved";
            req.ApprovedAt = DateTime.UtcNow;
            // optionally set completed/approved metadata here, e.g. CompletedAt
            await Db.SaveChangesAsync();

            StatusText = req.Status;
            StatusBadgeClass = "bg-primary";

            // reload display data
            await OnParametersSetAsync();
        }
        catch
        {
            await JS.InvokeVoidAsync("alert", "Failed to approve request.");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task RejectRequest()
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Reject this request? This action cannot be undone.");
        if (!confirmed) return;

        IsLoading = true;
        try
        {
            var req = await Db.ContractorRequests.FirstOrDefaultAsync(r => r.RequestId == requestId);
            if (req is null)
            {
                await JS.InvokeVoidAsync("alert", "Request not found.");
                return;
            }

            req.Status = "Cancelled";
            req.CancelledAt = DateTime.UtcNow;
            await Db.SaveChangesAsync();

            StatusText = req.Status;
            StatusBadgeClass = "bg-danger";

            await OnParametersSetAsync();
        }
        catch
        {
            await JS.InvokeVoidAsync("alert", "Failed to reject request.");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task ReturnRequest()
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Return this request for changes?");
        if (!confirmed) return;

        IsLoading = true;
        try
        {
            var req = await Db.ContractorRequests.FirstOrDefaultAsync(r => r.RequestId == requestId);
            if (req is null)
            {
                await JS.InvokeVoidAsync("alert", "Request not found.");
                return;
            }

            req.Status = "Draft";
            await Db.SaveChangesAsync();

            StatusText = req.Status;
            StatusBadgeClass = "bg-warning";

            await OnParametersSetAsync();
        }
        catch
        {
            await JS.InvokeVoidAsync("alert", "Failed to return request.");
        }
        finally
        {
            IsLoading = false;
        }
    }
}
