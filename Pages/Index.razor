@page "/dashboard"
@attribute [Authorize(Roles = "Approver,Requestor")]

@using Emerus.ETM.Admin.Data
@using Microsoft.EntityFrameworkCore
@using System
@inject AppDbContext DbContext
@inject NavigationManager Navigation

<PageTitle>Dashboard</PageTitle>

<div class="page-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3">
    <div>
        <h2 class="mb-0">Onboarding Dashboard</h2>
        <p class="text-muted mb-0">High level view of contractor onboarding activity.</p>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card kpi-card">
            <div class="card-body">
                <div class="kpi-label">Open Requests</div>
                <div class="kpi-value">@OpenRequestsCount</div>
                <div class="kpi-footnote">Submitted and in progress</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card kpi-card">
            <div class="card-body">
                <div class="kpi-label">Completed This Week</div>
                <div class="kpi-value">@CompletedThisWeekCount</div>
                <div class="kpi-footnote">Provisioning done</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card kpi-card">
            <div class="card-body">
                <div class="kpi-label">Pending Vendor Action</div>
                <div class="kpi-value">@PendingVendorActionCount</div>
                <div class="kpi-footnote">Missing documents</div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card kpi-card">
            <div class="card-body">
                <div class="kpi-label">Tasks Due Today</div>
                <div class="kpi-value">@TasksDueTodayCount</div>
                <div class="kpi-footnote">Across all facilities</div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <!-- Separate title row -->
    <div class="card-title-row px-3 py-2 border-bottom">
        <h5 class="mb-0">Recent Contractor Requests</h5>
    </div>

    <!-- Controls row: page-size on left, search + new button on right -->
    <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
        <div class="d-flex align-items-center gap-3">
            <small class="text-muted">Showing @PagedRows.Count() of @FilteredCount</small>

            <div class="btn-group btn-group-sm" role="group" aria-label="page size">
                <button class="btn btn-outline-secondary" @onclick="() => SetPageSize(10)" title="10 rows">10</button>
                <button class="btn btn-outline-secondary" @onclick="() => SetPageSize(20)" title="20 rows">20</button>
                <button class="btn btn-outline-secondary" @onclick="() => SetPageSize(30)" title="30 rows">30</button>
                <button class="btn btn-outline-secondary" @onclick="() => SetPageSize(50)" title="50 rows">50</button>
            </div>
        </div>

        <div class="d-flex gap-2 align-items-center">
            <div class="input-group input-group-sm">
                <span class="input-group-text">Search</span>
                <input class="form-control" placeholder="Contractor, vendor, facility or status" @bind="SearchText" @bind:event="oninput" />
            </div>

            <a class="btn btn-sm btn-primary btn-new-contractor" href="onboarding/new">New Contractor</a>
        </div>
    </div>

    <div class="card-body p-0 card-table-wrapper">
        <!-- added table-hover so Bootstrap applies hover behavior; custom CSS further ensures visibility -->
        <table class="table table-striped table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Contractor</th>
                    <th>Vendor</th>
                    <th>Facility</th>
                    <th>Start Date</th>
                    <th>Comments</th>
                    <th>Status</th>
                    <th class="text-end">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (!PagedRows.Any())
                {
                    <tr>
                        <td colspan="7" class="text-center p-4">
                            <div class="text-muted">No matching requests found.</div>
                        </td>
                    </tr>
                }
                else
                {
                    @foreach (var row in PagedRows)
                    {
                        <tr>
                            <td>@row.ContractorName</td>
                            <td>@row.VendorName</td>
                            <td>@row.Facility</td>
                            <td>@row.StartDate.ToShortDateString()</td>
                            <td title="@row.Comments" class="text-truncate" style="max-width:28ch;">@Truncate(row.Comments, 80)</td>
                            <td><span class="badge @GetStatusBadgeClass(row.Status)">@row.Status</span></td>
                            <td class="text-end">
                                @if (!IsFinalStatus(row.Status))
                                {
                                    @* If status is Draft navigate to onboarding/new in edit mode, otherwise go to request detail *@
                                    @if (string.Equals(row.Status, "Draft", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => EditDraft(row.Id)">Edit</button>
                                    }
                                    else
                                    {
                                        @if (IsApprover)
                                        {
                                            <a href="onboarding/request/@row.Id" class="btn btn-sm btn-outline-secondary">View</a>

                                        }
                                    }
                                }
                                else
                                {
                                    <span class="text-muted small">No actions</span>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>

    <div class="card-footer d-flex justify-content-between align-items-center">
        <div>
            <small class="text-muted">Page @CurrentPage of @TotalPages</small>
        </div>

        <div class="btn-group">
            <button class="btn btn-sm btn-outline-secondary" @onclick="PrevPage" disabled="@(CurrentPage == 1)">Previous</button>
            <button class="btn btn-sm btn-outline-secondary" @onclick="NextPage" disabled="@(CurrentPage == TotalPages)">Next</button>
        </div>
    </div>
</div>

<style>
    .kpi-card {
        border-radius: 8px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .kpi-label {
        font-size: .85rem;
        color: #6c757d;
    }

    .kpi-value {
        font-size: 1.6rem;
        font-weight: 700;
        margin-top: .25rem;
    }

    .kpi-footnote {
        font-size: .8rem;
        color: #6c757d;
        margin-top: .25rem;
    }

    .card-table-wrapper {
        max-height: 56vh;
        overflow: auto;
    }

    /* make status badges a little taller */
    .badge {
        padding: .45rem .6rem;
        font-size: .85rem;
    }

    /* New Contractor button: slightly wider so text fits on one line */
    .btn-new-contractor {
        min-width: 140px;
        white-space: nowrap;
    }

    /* ensure a visible hover even when table is striped:
       apply background to cells (td/th) on row hover so it overrides stripe cells */
    .table tbody tr {
        transition: background-color .12s ease;
    }

    .table.table-hover tbody tr:hover > td,
    .table.table-hover tbody tr:hover > th {
        background-color: rgba(13,110,253,0.06);
    }

    /* Title row styling */
    .card-title-row h5 {
        font-size: 1rem;
        margin: 0;
    }

    /* ensure comment column truncation shows ellipsis */
    td.text-truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
</style>

@code {
    public record DashboardRow(Guid Id, string ContractorName, string VendorName, string Facility, DateTime StartDate, string Status, DateTime CreatedAt, string? Comments);

    // populated from database on initialization
    private List<DashboardRow> MockData { get; set; } = new();

    // UI state
    private string SearchText { get; set; } = string.Empty;
    private int PageSize { get; set; } = 10;
    private int CurrentPage { get; set; } = 1;
    protected string? UserRole;

    protected override async Task OnInitializedAsync()
    {
        // Query recent contractor requests, include related person and partner.
        // Map fields safely with fallbacks so the UI always has values.
        MockData = await DbContext.ContractorRequests
            .Include(r => r.ContractorPerson)
            .Include(r => r.Partner)
            .OrderByDescending(r => r.CreatedAt)
            .Select(r => new DashboardRow(
                r.RequestId,
                (r.ContractorPerson != null
                    ? ((string.IsNullOrWhiteSpace(r.ContractorPerson.PreferredFirstName) ? r.ContractorPerson.FirstName : r.ContractorPerson.PreferredFirstName) + " " + r.ContractorPerson.LastName)
                    : "Unknown"),
                (r.Partner != null ? r.Partner.DisplayName : "Unknown"),
                (r.PrimaryFacility ?? string.Empty),
                (r.ContractorPerson != null
                    ? (r.ContractorPerson.StartDate ?? r.CreatedAt)
                    : r.CreatedAt),
                r.Status,
                r.CreatedAt,
                r.Comments ?? string.Empty
            ))
            .ToListAsync();

        var userDetails = await _commonService.GetCurrentUserAsync().ConfigureAwait(false);
        if (userDetails.IsAuthenticated)
        {
            UserRole = userDetails.Role;
        }
    }

    private bool IsApprover => string.Equals(UserRole, "Approver", StringComparison.OrdinalIgnoreCase);

    private static string GetStatusBadgeClass(string? status)
    {
        // normalize for safer comparisons
        var s = (status ?? string.Empty).Trim();

        return s switch
        {
            "Approved" => "bg-success",
            "Cancelled" => "bg-danger",
            "Draft" => "bg-secondary",
            // keep a sensible default for other statuses
            "Completed" => "bg-primary",
            "Submitted" => "bg-info",
            "In Progress" => "bg-info",
            "Returned" => "bg-warning",
            _ => "bg-secondary"
        };
    }

    // Consider Approved and Cancelled as final statuses with no actions
    private static bool IsFinalStatus(string? status)
        => string.Equals(status, "Approved", StringComparison.OrdinalIgnoreCase)
           || string.Equals(status, "Cancelled", StringComparison.OrdinalIgnoreCase);

    // Derived KPI values
    private int OpenRequestsCount => MockData.Count(r => !string.Equals(r.Status, "Approved", StringComparison.OrdinalIgnoreCase)
                                                         && !string.Equals(r.Status, "Cancelled", StringComparison.OrdinalIgnoreCase));

    private int CompletedThisWeekCount => MockData.Count(r => r.CreatedAt >= DateTime.UtcNow.AddDays(-7) && string.Equals(r.Status, "Approved", StringComparison.OrdinalIgnoreCase));

    private int PendingVendorActionCount => MockData.Count(r => r.Status?.Contains("Draft", StringComparison.OrdinalIgnoreCase) == true);

    private int TasksDueTodayCount => MockData.Count(r => r.StartDate.Date == DateTime.UtcNow.Date);

    // Filtering & paging helpers
    private IEnumerable<DashboardRow> FilteredRows => MockData
        .Where(r =>
            string.IsNullOrWhiteSpace(SearchText)
                || r.ContractorName.Contains(SearchText, StringComparison.OrdinalIgnoreCase)
                || r.VendorName.Contains(SearchText, StringComparison.OrdinalIgnoreCase)
                || r.Facility.Contains(SearchText, StringComparison.OrdinalIgnoreCase)
                || (r.Status ?? string.Empty).Contains(SearchText, StringComparison.OrdinalIgnoreCase)
        );

    private int FilteredCount => FilteredRows.Count();

    private int TotalPages => Math.Max(1, (int)Math.Ceiling(FilteredCount / (double)PageSize));

    private IEnumerable<DashboardRow> PagedRows
    {
        get
        {
            if (CurrentPage > TotalPages) CurrentPage = TotalPages;
            return FilteredRows.Skip((CurrentPage - 1) * PageSize).Take(PageSize);
        }
    }

    private void SetPageSize(int size)
    {
        PageSize = size;
        CurrentPage = 1;
    }

    private void PrevPage()
    {
        if (CurrentPage > 1) CurrentPage--;
    }

    private void NextPage()
    {
        if (CurrentPage < TotalPages) CurrentPage++;
    }

    private void EditDraft(Guid id)
    {
        // navigate to onboarding/new in edit mode using query parameter the page already supports
        Navigation.NavigateTo($"/onboarding/new?editId={id}");
    }

    private static string Truncate(string? value, int maxLength)
    {
        if (string.IsNullOrEmpty(value)) return string.Empty;
        if (value.Length <= maxLength) return value;
        return value.Substring(0, maxLength - 1).TrimEnd() + "…";
    }
}
