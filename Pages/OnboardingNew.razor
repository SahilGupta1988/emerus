@page "/onboarding/new"
@using Emerus.ETM.Admin.Data
@inject AppDbContext Db
@inject NavigationManager Navigation

<PageTitle>New Contractor</PageTitle>

<div class="page-header">
    <h2>New Contractor</h2>
    <p class="text-muted">Enter contractor details and onboarding requirements.</p>
</div>

<div class="card mt-3">
    <div class="card-body">
        <ul class="nav nav-pills mb-3 wizard-steps">
            @for (int i = 0; i < Steps.Count; i++)
            {
                var step = Steps[i];
                var active = i == CurrentStepIndex ? "active" : "";
                <li class="nav-item">
                    <button type="button"
                            class="nav-link @active"
                            disabled="@(i > MaxStepIndex)"
                            @onclick="(() => GoToStep(i))">
                        <span class="step-number">@((i + 1).ToString())</span> @step
                    </button>
                </li>
            }
        </ul>

        @switch (CurrentStepIndex)
        {
            case 0:
                <DemographicsStep Model="Demographics" />
                break;
            case 1:
                <JobStep Model="JobInfo" />
                break;
            case 2:
                <AccessStep Model="AccessInfo" />
                break;
            case 3:
                <HardwareStep Model="Hardware" />
                break;
            case 4:
                <BadgeStep Model="Badge" />
                break;
            case 5:
                <ComplianceStep />
                break;
            case 6:
                <ReviewStep Demographics="Demographics"
                            JobInfo="JobInfo"
                            AccessInfo="AccessInfo"
                            Hardware="Hardware"
                            Badge="Badge" />
                break;
        }

        <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-outline-secondary" @onclick="Previous" disabled="@(CurrentStepIndex == 0)">Back</button>
            <div>
                <button class="btn btn-secondary me-2" @onclick="SaveDraft">Save Draft</button>
                @if (CurrentStepIndex < Steps.Count - 1)
                {
                    <button class="btn btn-primary" @onclick="Next">Next</button>
                }
                else
                {
                    <button class="btn btn-success" @onclick="Submit" disabled="@IsSubmitting">
                        @if (IsSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        }
                        Submit
                    </button>
                }
            </div>
        </div>
        @if (!string.IsNullOrEmpty(SubmitError))
        {
            <div class="alert alert-danger mt-3">@SubmitError</div>
        }
    </div>
</div>

@code {


    private List<string> Steps = new()
    {
        "Demographics",
        "Job & Dates",
        "Access",
        "Hardware",
        "Badge",
        "Compliance",
        "Review"
    };

    private int CurrentStepIndex { get; set; } = 0;
    private int MaxStepIndex { get; set; } = 0;

    private DemographicsModel Demographics { get; set; } = new();
    private JobModel JobInfo { get; set; } = new();
    private AccessModel AccessInfo { get; set; } = new();
    private HardwareModel Hardware { get; set; } = new();
    private BadgeModel Badge { get; set; } = new();

    // New: store the GUID generated when creating/saving a request (draft or final)
    private Guid SavedRequestId { get; set; }


    void GoToStep(int i)
    {
        if (i <= MaxStepIndex)
        {
            CurrentStepIndex = i;
        }
    }

    @using Microsoft.EntityFrameworkCore
    async Task Next()
    {
        if (CurrentStepIndex < Steps.Count - 1)
        {
            if (CurrentStepIndex == 0)
            {
                await SaveDemographicDetails();
            }
            if (CurrentStepIndex == 1)
            {
                await SaveJobAndDates();
            }
            if (CurrentStepIndex == 2)
            {
                await SaveAccessTargets();
            }
            if (CurrentStepIndex == 3)
            {
                await SaveHardware();
            }
            if (CurrentStepIndex == 4)
            {
                await SaveBadge();
            }
            if (CurrentStepIndex == 5)
            {
                // await SaveCompliance();
            }

            CurrentStepIndex++;
            if (CurrentStepIndex > MaxStepIndex)
            {
                MaxStepIndex = CurrentStepIndex;
            }
        }
    }


    void Previous()
    {
        if (CurrentStepIndex > 0)
        {
            CurrentStepIndex--;
        }
    }

    async Task SaveDraft()
    {
        if (CurrentStepIndex == 0)
        {
            await SaveDemographicDetails();
        }
        if (CurrentStepIndex == 1)
        {
            await SaveJobAndDates();
        }
        if (CurrentStepIndex == 2)
        {
            await SaveAccessTargets();
        }
        if (CurrentStepIndex == 3)
        {
            await SaveHardware();
        }
        if (CurrentStepIndex == 4)
        {
            await SaveBadge();
        }
        if (CurrentStepIndex == 5)
        {
            // await SaveCompliance();
        }
    }

    private bool IsSubmitting;
    private string? SubmitError;



    void Submit()
    {
        IsSubmitting = true;
        SubmitError = null;

        try
        {
            if (SavedRequestId == Guid.Empty)
            {
                SubmitError = "No saved request id available to update.";
                return;
            }

            // Try to find an existing person for this request id
            var existing = Db.ContractorRequests.FirstOrDefault(p => p.RequestId == SavedRequestId);

            if (existing != null)
            {
                existing.Status = "Submitted";
                existing.SubmittedAt = DateTime.UtcNow;
                Db.SaveChanges();
            }
            Navigation.NavigateTo($"/");
        }
        catch (Exception ex)
        {
            // Surface a friendly error message and keep the page interactive
            SubmitError = "Unable to submit request. " + ex.Message;
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }


    async Task SaveDemographicDetails()
    {
        // Create the ContractorRequest entity and assign a GUID id.
        try
        {
            var request = new ContractorRequest
        {
            RequestId = Guid.NewGuid(),
            RequestedByUpn = $"{Demographics.FirstName} {Demographics.LastName}",
            PartnerCode = "AGENCY1",
            RequestType = "Requestor",
            CreatedAt = DateTime.UtcNow,
            Status = "Draft",
            UserId = Guid.Parse("6116088C-850F-4C38-A342-22CCE2071DC3")
                // Reviewer = string.Empty
        };


            // Map page models to ContractorPerson entity. Fill only known fields; other DB columns will use defaults/nulls.
            var person = new ContractorPerson
        {
            RequestId = request.RequestId,
            FirstName = Demographics.FirstName,
            PreferredFirstName = Demographics.PreferredFirstName,
            LastName = Demographics.LastName,
            PreferredLastName = Demographics.PreferredLastName,
            PersonalEmail = Demographics.PersonalEmail,
            CellPhone = Demographics.CellPhone,
            DateOfBirth = Demographics.DateOfBirth,
            Gender = Demographics.Gender,
            AddressLine1 = Demographics.AddressLine1,
            AddressLine2 = Demographics.AddressLine2,
            City = Demographics.City,
            StateProvince = Demographics.State,
            PostalCode = Demographics.Postal,
            CountryCode = Demographics.Country,
            CreatedAt = DateTime.UtcNow,
            UpdatedAt = DateTime.UtcNow
        };

            Db.ContractorRequests.Add(request);
            Db.ContractorPeople.Add(person);
            await Db.SaveChangesAsync();
            // Store the generated GUID for later reference (draft id)
            SavedRequestId = request.RequestId;
        }
        catch (Exception ex)
        {
            // Surface a friendly error message and keep the page interactive
            SubmitError = "Unable to submit request. " + ex.Message;
        }
        finally
        {
            StateHasChanged();
        }

    }


    async Task SaveJobAndDates()
    {
        try
        {
            if (SavedRequestId == Guid.Empty)
            {
                SubmitError = "No saved request id available to update.";
                return;
            }

            var existing = await Db.ContractorPeople.FirstOrDefaultAsync(p => p.RequestId == SavedRequestId);

            if (existing != null)
            {
                existing.JobTitle = JobInfo.JobTitle;
                existing.Department = JobInfo.Department;
                existing.StartDate = JobInfo.StartDate;
                existing.PriorEmployeeFlag = JobInfo.PriorEmployeeFlag;
                existing.ExternalEmployeeId = JobInfo.ExternalEmployeeId;
                existing.UpdatedAt = DateTime.UtcNow;

                await Db.SaveChangesAsync();
            }
            else
            {
                var person = new ContractorPerson
            {
                RequestId = SavedRequestId,
                JobTitle = JobInfo.JobTitle,
                Department = JobInfo.Department,
                StartDate = JobInfo.StartDate,
                PriorEmployeeFlag = JobInfo.PriorEmployeeFlag,
                ExternalEmployeeId = JobInfo.ExternalEmployeeId,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            };
                Db.ContractorPeople.Add(person);
                await Db.SaveChangesAsync();
            }
        }
        catch (Exception ex)
        {
            SubmitError = "Unable to save job/dates. " + ex.Message;
        }
        finally
        {
            StateHasChanged();
        }
    }



    async Task SaveAccessTargets()
    {
        try
        {
            if (SavedRequestId == Guid.Empty)
            {
                SubmitError = "No saved request id available to update.";
                return;
            }

            // Get a list of existing access records for this request id
            var existingList = await Db.ContractorAccessRequest
                                       .Where(p => p.RequestId == SavedRequestId)
                                       .ToListAsync();

            if (existingList.Any())
            {
                // If records exist then delete them before re-adding
                Db.ContractorAccessRequest.RemoveRange(existingList);
                await Db.SaveChangesAsync();
            }

            // Re-create access records — one per requested target.
            // Adjust the property names below to match your ContractorAccessRequest entity.
            foreach (var target in AccessInfo.RequestedTargets)
            {
                var access = new ContractorAccessRequest
                {
                    AccessRequestId = Guid.NewGuid(),
                    RequestId = SavedRequestId,
                    TargetId = target.TargetId,
                    Environment = "Prod",
                    CreatedAt = DateTime.UtcNow
                };

                Db.ContractorAccessRequest.Add(access);
            }

            await Db.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            SubmitError = "Unable to save access targets. " + ex.Message;
        }
        finally
        {
            StateHasChanged();
        }
    }


    async Task SaveHardware()
    {
        try
        {
            if (SavedRequestId == Guid.Empty)
            {
                SubmitError = "No saved request id available to update.";
                return;
            }

            var existing = await Db.ContractorHardwareRequest.FirstOrDefaultAsync(p => p.RequestId == SavedRequestId);

            if (existing != null)
            {
                existing.NeedsLaptop = Hardware.NeedsLaptop;
                existing.NeedsDock = Hardware.NeedsDock;
                existing.MonitorCount = Hardware.MonitorCount;
                existing.NeedsHeadset = Hardware.NeedsHeadset;
                existing.NeedsHotspot = Hardware.NeedsHotspot;
                existing.Notes = Hardware.Notes;
                existing.UpdatedAt = DateTime.UtcNow;
                await Db.SaveChangesAsync();
            }
            else
            {
                var hardware = new ContractorHardwareRequest
            {
                RequestId = SavedRequestId,
                NeedsLaptop = Hardware.NeedsLaptop,
                NeedsDock = Hardware.NeedsDock,
                MonitorCount = Hardware.MonitorCount,
                NeedsHeadset = Hardware.NeedsHeadset,
                NeedsHotspot = Hardware.NeedsHotspot,
                Notes = Hardware.Notes,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            };
                Db.ContractorHardwareRequest.Add(hardware);
                await Db.SaveChangesAsync();
            }
        }
        catch (Exception ex)
        {
            SubmitError = "Unable to save hardware. " + ex.Message;
        }
        finally
        {
            StateHasChanged();
        }
    }


    async Task SaveBadge()
    {
        try
        {
            if (SavedRequestId == Guid.Empty)
            {
                SubmitError = "No saved request id available to update.";
                return;
            }

            var existing = await Db.ContractorRequests.FirstOrDefaultAsync(p => p.RequestId == SavedRequestId);

            if (existing != null)
            {

                existing.PrimaryFacility = Badge.PrimaryFacility;
                existing.RequestType = Badge.RequestType;
                await Db.SaveChangesAsync();
            }
            else
            {
                var request = new ContractorRequest
            {
                RequestId = SavedRequestId,
                PrimaryFacility = Badge.PrimaryFacility,
                RequestType = Badge.RequestType,
                CreatedAt = DateTime.UtcNow,
            };
                Db.ContractorRequests.Add(request);
                await Db.SaveChangesAsync();
            }
        }
        catch (Exception ex)
        {
            SubmitError = "Unable to save hardware. " + ex.Message;
        }
        finally
        {
            StateHasChanged();
        }
    }


    public class DemographicsModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string PreferredFirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string PreferredLastName { get; set; } = string.Empty;
        public string PersonalEmail { get; set; } = string.Empty;
        public string CellPhone { get; set; } = string.Empty;
        public DateTime DateOfBirth { get; set; } = DateTime.Today;
        public string Gender { get; set; } = string.Empty;
        public string AddressLine1 { get; set; } = string.Empty;
        public string AddressLine2 { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
        public string State { get; set; } = string.Empty;
        public string Postal { get; set; } = string.Empty;
        public string Country { get; set; } = string.Empty;
        public string Identity { get; set; } = string.Empty;
    }

    public class JobModel
    {
        public string AgencyName { get; set; } = string.Empty;
        public string JobTitle { get; set; } = string.Empty;
        public string JobCode { get; set; } = string.Empty;
        public string Department { get; set; } = string.Empty;
        public string ExternalEmployeeId { get; set; } = string.Empty;
        public bool PriorEmployeeFlag { get; set; } = false;
        public DateTime StartDate { get; set; } = DateTime.Today;
    }

    public class AccessModel
    {
        public List<RequestTargetModel> RequestedTargets { get; set; } = new();
    }

    public class RequestTargetModel
    {
        public Guid AccessRequestId { get; set; }
        public Guid RequestId { get; set; }
        public Guid TargetId { get; set; }
        public string Environment { get; set; }
        public string ChangeType { get; set; }
        public string MirrorUserUpn { get; set; }
        public string DetailJson { get; set; }
        public DateTime CreatedAt { get; set; }
        public string CreatedByUpn{ get; set; }
    }

    public class HardwareModel
    {
        public bool NeedsLaptop { get; set; } = true;
        public bool NeedsDock { get; set; } = true;
        public int MonitorCount { get; set; } = 2;
        public bool NeedsHeadset { get; set; } = true;
        public bool NeedsHotspot { get; set; } = true;
        public string Notes { get; set; } = string.Empty;
    }
    
    public class BadgeModel
    {
        public bool NeedsBadge { get; set; } = true;
        public string PrimaryFacility { get; set; } = string.Empty;
        public string RequestType { get; set; } = string.Empty;
    }
}
