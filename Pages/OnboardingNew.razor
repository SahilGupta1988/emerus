@page "/onboarding/new"
@using Emerus.ETM.Admin.Data
@inject AppDbContext Db
@inject NavigationManager Navigation
@attribute [Authorize(Roles = "Approver,Requestor")]

<PageTitle>New Contractor</PageTitle>

<div class="page-header">
    <h2>New Contractor</h2>
    <p class="text-muted">Enter contractor details and onboarding requirements.</p>
</div>

<div class="card mt-3">
    <div class="card-body">
        <ul class="nav nav-pills mb-3 wizard-steps">
            @for (int i = 0; i < Steps.Count; i++)
            {
                var step = Steps[i];
                var active = i == CurrentStepIndex ? "active" : "";
                <li class="nav-item">
                    <button type="button"
                            class="nav-link @active"
                            disabled="@(i > MaxStepIndex)"
                            @onclick="(() => GoToStep(i))">
                        <span class="step-number">@((i + 1).ToString())</span> @step
                    </button>
                </li>
            }
        </ul>

        @switch (CurrentStepIndex)
        {
            case 0:
                <DemographicsStep Model="Demographics" />
                break;
            case 1:
                <JobStep Model="JobInfo" />
                break;
            case 2:
                <AccessStep Model="AccessInfo" />
                break;
            case 3:
                <HardwareStep Model="Hardware" />
                break;
            case 4:
                <BadgeStep Model="Badge" />
                break;
            case 5:
                <ComplianceStep />
                break;
            case 6:
                <ReviewStep Demographics="Demographics"
                            JobInfo="JobInfo"
                            AccessInfo="AccessInfo"
                            Hardware="Hardware"
                            Badge="Badge" />
                break;
        }

        <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-outline-secondary" @onclick="Previous" disabled="@(CurrentStepIndex == 0)">Back</button>
            <div>
                <button class="btn btn-secondary me-2" @onclick="SaveDraft">Save Draft</button>
                @if (CurrentStepIndex < Steps.Count - 1)
                {
                    <button class="btn btn-primary" @onclick="Next">Next</button>
                }
                else
                {
                    <button class="btn btn-success" @onclick="Submit" disabled="@IsSubmitting">
                        @if (IsSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        }
                        Submit
                    </button>
                }
            </div>
        </div>
        @if (!string.IsNullOrEmpty(SubmitError))
        {
            <div class="alert alert-danger mt-3">@SubmitError</div>
        }
    </div>
</div>

@code {
    private List<string> Steps = new()
    {
        "Demographics",
        "Job & Dates",
        "Access",
        "Hardware",
        "Badge",
        "Compliance",
        "Review"
    };

    private int CurrentStepIndex { get; set; } = 0;
    private int MaxStepIndex { get; set; } = 0;

    private DemographicsModel Demographics { get; set; } = new();
    private JobModel JobInfo { get; set; } = new();
    private AccessModel AccessInfo { get; set; } = new();
    private HardwareModel Hardware { get; set; } = new();
    private BadgeModel Badge { get; set; } = new();


    void GoToStep(int i)
    {
        if (i <= MaxStepIndex)
        {
            CurrentStepIndex = i;
        }
    }

    void Next()
    {
        if (CurrentStepIndex < Steps.Count - 1)
        {
            CurrentStepIndex++;
            if (CurrentStepIndex > MaxStepIndex)
            {
                MaxStepIndex = CurrentStepIndex;
            }
        }
    }

    void Previous()
    {
        if (CurrentStepIndex > 0)
        {
            CurrentStepIndex--;
        }
    }

    void SaveDraft()
    {
        // TODO: Hook up to backend
    }

    private bool IsSubmitting;
    private string? SubmitError;

    async Task Submit()
    {
        // TODO: Persist and redirect
        IsSubmitting = true;
        SubmitError = null;

        try
        {
            // Create request id that will be used in routes/listing (MyContractors uses GUIDs)
            // var requestId = Guid.NewGuid();

            // Create the ContractorRequest entity and assign a GUID id.
            var request = new ContractorRequest
            {
                RequestId = Guid.NewGuid(),
                RequestedByUpn = $"{Demographics.FirstName} {Demographics.LastName}",
                PartnerCode = "AGENCY1",
                PrimaryFacility = Badge.PrimaryFacility,
                RequestType = Badge.RequestType,
                SubmittedAt = DateTime.UtcNow,//JobInfo.StartDate,
                CreatedAt = DateTime.UtcNow,//JobInfo.StartDate,
                Status = "New",
                UserId = Guid.Parse("6116088C-850F-4C38-A342-22CCE2071DC3")
                // Reviewer = string.Empty
            };

            // Map page models to ContractorPerson entity. Fill only known fields; other DB columns will use defaults/nulls.
            var person = new ContractorPerson
            {
                RequestId = request.RequestId,
                FirstName = Demographics.FirstName,
                PreferredFirstName = Demographics.PreferredFirstName,
                LastName = Demographics.LastName,
                PreferredLastName = Demographics.PreferredLastName,
                PersonalEmail = Demographics.PersonalEmail,
                CellPhone = Demographics.CellPhone,
                DateOfBirth = Demographics.DateOfBirth,
                Gender = Demographics.Gender,
                AddressLine1 = Demographics.AddressLine1,
                AddressLine2 = Demographics.AddressLine2,
                City = Demographics.City,
                StateProvince = Demographics.State,
                PostalCode = Demographics.Postal,
                CountryCode = Demographics.Country,
                JobTitle = JobInfo.JobTitle,
                Department = JobInfo.Department,
                StartDate = JobInfo.StartDate,
                PriorEmployeeFlag = JobInfo.PriorEmployeeFlag,
                ExternalEmployeeId = JobInfo.ExternalEmployeeId,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
                // set other properties as needed (CellPhone, Address, etc.)
            };

            var hardware = new ContractorHardwareRequest
            {
                RequestId = request.RequestId,
                NeedsLaptop = Hardware.NeedsLaptop,
                NeedsDock = Hardware.NeedsDock,
                MonitorCount = Hardware.MonitorCount,
                NeedsHeadset = Hardware.NeedsHeadset,
                NeedsHotspot = Hardware.NeedsHotspot,
                Notes = Hardware.Notes,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            };

            // Add both to the context. Fluent configuration ensures RequestId is the FK.
            Db.ContractorRequests.Add(request);
            Db.ContractorPeople.Add(person);
            Db.ContractorHardwareRequest.Add(hardware);
            await Db.SaveChangesAsync();

            // Navigate to request details (assumes route exists: /onboarding/request/{id})
            // Navigation.NavigateTo($"/onboarding/request/{request.RequestId}");
            // Navigation.NavigateTo($"/admin/config/vendors");
            Navigation.NavigateTo($"/");
        }
        catch (Exception ex)
        {
            // Surface a friendly error message and keep the page interactive
            SubmitError = "Unable to submit request. " + ex.Message;
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }

    public class DemographicsModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string PreferredFirstName { get; set; } = string.Empty;
        public string LastName  { get; set; } = string.Empty;
        public string PreferredLastName { get; set; } = string.Empty;
        public string PersonalEmail { get; set; } = string.Empty;
        public string CellPhone { get; set; } = string.Empty;
        public DateTime DateOfBirth { get; set; } = DateTime.Today;
        public string Gender { get; set; } = string.Empty;
        public string AddressLine1 { get; set; } = string.Empty;
        public string AddressLine2 { get; set; } = string.Empty;
        public string City { get; set; } = string.Empty;
        public string State { get; set; } = string.Empty;
        public string Postal { get; set; } = string.Empty;
        public string Country { get; set; } = string.Empty;
        public string Identity { get; set; } = string.Empty;
    }

    public class JobModel
    {
        public string AgencyName { get; set; } = string.Empty;
        public string JobTitle { get; set; } = string.Empty;
        public string JobCode { get; set; } = string.Empty;
        public string Department { get; set; } = string.Empty;
        public string ExternalEmployeeId { get; set; } = string.Empty;
        public bool PriorEmployeeFlag { get; set; } = false;
        public DateTime StartDate { get; set; } = DateTime.Today;
    }

    public class AccessModel
    {
        public List<string> RequestedTargets { get; set; } = new();
    }

    public class HardwareModel
    {
        public bool NeedsLaptop { get; set; } = true;
        public bool NeedsDock { get; set; } = true;
        public int MonitorCount { get; set; } = 2;
        public bool NeedsHeadset { get; set; } = true;
        public bool NeedsHotspot { get; set; } = true;
        public string Notes { get; set; } = string.Empty;
    }

    public class BadgeModel
    {
        public bool NeedsBadge { get; set; } = true;
        public string PrimaryFacility { get; set; } = string.Empty;
        public string RequestType { get; set; } = string.Empty;
    }
}
