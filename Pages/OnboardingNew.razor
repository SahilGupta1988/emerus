@page "/onboarding/new"
@using Emerus.ETM.Admin.Data
@using Microsoft.EntityFrameworkCore
@using System.ComponentModel.DataAnnotations
@using System.Collections.Generic
@using Microsoft.AspNetCore.Components
@using System.Linq
@inject AppDbContext Db
@inject NavigationManager Navigation
@inject IJSRuntime JS
@attribute [Authorize(Roles = "Approver,Requestor")]

<PageTitle>New Contractor</PageTitle>

<div class="page-header">
    <h2>New Contractor</h2>
    <p class="text-muted">Enter contractor details and onboarding requirements.</p>
</div>

<div class="card mt-3">
    <div class="card-body">
        <ul class="nav nav-pills mb-3 wizard-steps">
            @for (int i = 0; i < Steps.Count; i++)
            {
                var step = Steps[i];
                var active = i == CurrentStepIndex ? "active" : "";
                <li class="nav-item">
                    <button type="button"
                            class="nav-link @active"
                            disabled="@(i > MaxStepIndex || IsProcessingNext)"
                            @onclick="(() => GoToStep(i))">
                        <span class="step-number">@((i + 1).ToString())</span> @step
                    </button>
                </li>
            }
        </ul>

        @switch (CurrentStepIndex)
        {
            case 0:
                <DemographicsStep Model="Demographics" />
                break;
            case 1:
                <JobStep Model="JobInfo" />
                break;
            case 2:
                <AccessStep Model="AccessInfo" />
                break;
            case 3:
                <HardwareStep Model="Hardware" />
                break;
            case 4:
                <BadgeStep Model="Badge" />
                break;
            case 5:
                <ComplianceStep />
                break;
            case 6:
                <ReviewStep Demographics="Demographics"
                            JobInfo="JobInfo"
                            AccessInfo="AccessInfo"
                            Hardware="Hardware"
                            Badge="Badge" />
                break;
        }

        <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-outline-secondary" @onclick="Previous" disabled="@(CurrentStepIndex == 0 || IsProcessingNext)">Back</button>
            <div>
                <button class="btn btn-secondary me-2" @onclick="SaveDraft" disabled="@IsProcessingNext">Save Draft</button>
                @if (CurrentStepIndex < Steps.Count - 1)
                {
                    <button class="btn btn-primary" @onclick="Next" disabled="@IsProcessingNext">
                        @if (IsProcessingNext)
                        {
                            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                        }
                        Next
                    </button>
                }
                else
                {
                    <button class="btn btn-success" @onclick="Submit" disabled="@IsSubmitting">
                        @if (IsSubmitting)
                        {
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        }
                        Submit
                    </button>
                }
            </div>
        </div>
        @if (!string.IsNullOrEmpty(SubmitError))
        {
            <div class="alert alert-danger mt-3">@SubmitError</div>
        }
    </div>
</div>

@using Emerus.ETM.Admin.Pages.AccessStep
@using Emerus.ETM.Admin.Pages.BadgeStep
@using Emerus.ETM.Admin.Pages.ComplianceStep
@using Emerus.ETM.Admin.Pages.DemographicsStep
@using Emerus.ETM.Admin.Pages.HardwareStep
@using Emerus.ETM.Admin.Pages.JobStep
@code {

    private List<string> Steps = new()
    {
        "Demographics",
        "Job & Dates",
        "Access",
        "Hardware",
        "Badge",
        "Compliance",
        "Review"
    };

    private int CurrentStepIndex { get; set; } = 0;
    private int MaxStepIndex { get; set; } = 0;

    private DemographicsModel Demographics { get; set; } = new();
    private JobModel JobInfo { get; set; } = new();
    private AccessModel AccessInfo { get; set; } = new();
    private HardwareModel Hardware { get; set; } = new();
    private BadgeModel Badge { get; set; } = new();

    // support opening the page in edit mode via query string: /onboarding/new?editId={guid}
    [Parameter]
    [SupplyParameterFromQuery(Name = "editId")]
    public Guid? EditId { get; set; }

    // New: store the GUID generated when creating/saving a request (draft or final)
    private Guid SavedRequestId { get; set; }

    // State to show loader / prevent double-click while performing Next operation
    private bool IsProcessingNext { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        // If an editId is provided, load that request and populate the form models for editing.
        if (EditId is not null && EditId != Guid.Empty)
        {
            var id = EditId.Value;

            var request = await Db.ContractorRequests
                .Include(r => r.ContractorPerson)
                .Include(r => r.ContractorHardwareRequest)
                .FirstOrDefaultAsync(r => r.RequestId == id);

            if (request is not null)
            {
                SavedRequestId = request.RequestId;

                var person = request.ContractorPerson;
                var hardware = request.ContractorHardwareRequest;

                Demographics = new DemographicsModel
                {
                    FirstName = person?.FirstName ?? string.Empty,
                    PreferredFirstName = person?.PreferredFirstName ?? string.Empty,
                    LastName = person?.LastName ?? string.Empty,
                    PreferredLastName = person?.PreferredLastName ?? string.Empty,
                    PersonalEmail = person?.PersonalEmail ?? string.Empty,
                    CellPhone = person?.CellPhone ?? string.Empty,
                    DateOfBirth = person?.DateOfBirth ?? DateTime.Today,
                    Gender = person?.Gender ?? string.Empty,
                    AddressLine1 = person?.AddressLine1 ?? string.Empty,
                    AddressLine2 = person?.AddressLine2 ?? string.Empty,
                    City = person?.City ?? string.Empty,
                    StateProvince = person?.StateProvince ?? string.Empty,
                    PostalCode = person?.PostalCode ?? string.Empty,
                    CountryCode = person?.CountryCode ?? string.Empty,
                    Identity = string.Empty
                };

                JobInfo = new JobModel
                {
                    AgencyName = person?.AgencyName ?? string.Empty,
                    JobTitle = person?.JobTitle ?? string.Empty,
                    JobCode = person?.JobCode ?? string.Empty,
                    Department = person?.Department ?? string.Empty,
                    ExternalEmployeeId = person?.ExternalEmployeeId ?? string.Empty,
                    PriorEmployeeFlag = person?.PriorEmployeeFlag ?? false,
                    StartDate = person?.StartDate ?? DateTime.Today
                };

                AccessInfo = new AccessModel
                {
                    RequestedTargets = await Db.ContractorAccessRequest
                        .Where(a => a.RequestId == SavedRequestId)
                        .Select(a => new RequestTargetModel
                        {
                            AccessRequestId = a.AccessRequestId,
                            RequestId = a.RequestId,
                            TargetId = a.TargetId,
                            Environment = a.Environment,
                            ChangeType = a.ChangeType,
                            MirrorUserUpn = a.MirrorUserUpn,
                            DetailJson = a.DetailJson,
                            CreatedAt = a.CreatedAt,
                            CreatedByUpn = a.CreatedByUpn
                        }).ToListAsync()
                };

                Hardware = new HardwareModel
                {
                    NeedsLaptop = hardware?.NeedsLaptop ?? true,
                    NeedsDock = hardware?.NeedsDock ?? true,
                    MonitorCount = hardware?.MonitorCount ?? 2,
                    NeedsHeadset = hardware?.NeedsHeadset ?? true,
                    NeedsHotspot = hardware?.NeedsHotspot ?? true,
                    Notes = hardware?.Notes ?? string.Empty
                };

                Badge = new BadgeModel
                {
                    NeedsBadge = !string.IsNullOrWhiteSpace(request.RequestType),
                    PrimaryFacility = request.PrimaryFacility ?? string.Empty,
                    RequestType = request.RequestType ?? string.Empty
                };

                // Allow the user to navigate all steps while editing existing draft
                MaxStepIndex = Steps.Count - 1;
                CurrentStepIndex = 0;

                StateHasChanged();
            }
            else
            {
                // If not found, navigate back to dashboard to avoid editing empty id
                Navigation.NavigateTo("/");
            }
        }
    }

    void GoToStep(int i)
    {
        if (i <= MaxStepIndex && !IsProcessingNext)
        {
            CurrentStepIndex = i;
        }
    }

    async Task Next()
    {
        if (CurrentStepIndex >= Steps.Count - 1 || IsProcessingNext)
        {
            return;
        }

        IsProcessingNext = true;
        SubmitError = null;
        StateHasChanged();

        try
        {
            bool savedOk = true;

            if (CurrentStepIndex == 0)
            {
                savedOk = await SaveDemographicDetails();
            }
            else if (CurrentStepIndex == 1)
            {
                savedOk = await SaveJobAndDates();
            }
            else if (CurrentStepIndex == 2)
            {
                savedOk = await SaveAccessTargets();
            }
            else if (CurrentStepIndex == 3)
            {
                savedOk = await SaveHardware();
            }
            else if (CurrentStepIndex == 4)
            {
                savedOk = await SaveBadge();
            }
            else if (CurrentStepIndex == 5)
            {
                // await SaveCompliance(); // implement with bool return if needed
            }

            // Only advance if save succeeded
            if (savedOk)
            {
                CurrentStepIndex++;
                if (CurrentStepIndex > MaxStepIndex)
                {
                    MaxStepIndex = CurrentStepIndex;
                }
            }
            else
            {
                // Save methods set SubmitError; keep user on current step
            }
        }
        finally
        {
            IsProcessingNext = false;
            StateHasChanged();
        }
    }

    void Previous()
    {
        if (CurrentStepIndex > 0 && !IsProcessingNext)
        {
            CurrentStepIndex--;
        }
    }

    async Task SaveDraft()
    {
        if (IsProcessingNext) return;

        try
        {
            // Save draft of current step - keep previous behavior but do not navigate
            if (CurrentStepIndex == 0)
            {
                await SaveDemographicDetails();
            }
            if (CurrentStepIndex == 1)
            {
                await SaveJobAndDates();
            }
            if (CurrentStepIndex == 2)
            {
                await SaveAccessTargets();
            }
            if (CurrentStepIndex == 3)
            {
                await SaveHardware();
            }
            if (CurrentStepIndex == 4)
            {
                await SaveBadge();
            }
            if (CurrentStepIndex == 5)
            {
                // await SaveCompliance();
            }
        }
        finally
        {
            StateHasChanged();
        }
    }

    private bool IsSubmitting;
    private string? SubmitError;

    void Submit()
    {
        IsSubmitting = true;
        SubmitError = null;

        try
        {
            if (SavedRequestId == Guid.Empty)
            {
                SubmitError = "No saved request id available to update.";
                return;
            }

            // Try to find an existing person for this request id
            var existing = Db.ContractorRequests.FirstOrDefault(p => p.RequestId == SavedRequestId);

            if (existing != null)
            {
                existing.Status = "Submitted";
                existing.SubmittedAt = DateTime.UtcNow;
                Db.SaveChanges();
            }
            Navigation.NavigateTo($"/");
        }
        catch (Exception ex)
        {
            // Surface a friendly error message and keep the page interactive
            SubmitError = "Unable to submit request. " + ex.Message;
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }

    async Task<bool> SaveDemographicDetails()
    {
        SubmitError = null;

        // Validate the Demographics model using DataAnnotations (and IValidatableObject)
        var validationContext = new ValidationContext(Demographics);
        var validationResults = new List<ValidationResult>();
        bool isValid = Validator.TryValidateObject(Demographics, validationContext, validationResults, validateAllProperties: true);

        if (!isValid)
        {
            // Aggregate messages and surface them
            var messages = validationResults
                .Where(r => !string.IsNullOrWhiteSpace(r.ErrorMessage))
                .Select(r => r.ErrorMessage!.Trim())
                .Distinct()
                .ToList();

            SubmitError = "Validation errors: " + string.Join(" | ", messages);

            // show a popup alert so the user is immediately notified
            try
            {
                if (JS is not null)
                {
                    // Use a simple alert; if you prefer a styled modal, replace with custom modal logic
                    await JS.InvokeVoidAsync("alert", SubmitError);
                }
            }
            catch
            {
                // ignore JS interop errors; SubmitError will still show in the UI
            }

            StateHasChanged();
            return false;
        }

        try
        {
            // If we already have a SavedRequestId, update the existing request/person; otherwise create new
            if (SavedRequestId == Guid.Empty)
            {
                var request = new ContractorRequest
                {
                    RequestId = Guid.NewGuid(),
                    RequestedByUpn = $"{Demographics.FirstName} {Demographics.LastName}",
                    PartnerCode = "AGENCY1",
                    RequestType = "Requestor",
                    CreatedAt = DateTime.UtcNow,
                    Status = "Draft",
                    UserId = Guid.Parse("6116088C-850F-4C38-A342-22CCE2071DC3")
                };

                var person = new ContractorPerson
                {
                    RequestId = request.RequestId,
                    FirstName = Demographics.FirstName,
                    PreferredFirstName = Demographics.PreferredFirstName,
                    LastName = Demographics.LastName,
                    PreferredLastName = Demographics.PreferredLastName,
                    PersonalEmail = Demographics.PersonalEmail,
                    CellPhone = Demographics.CellPhone,
                    DateOfBirth = Demographics.DateOfBirth,
                    Gender = Demographics.Gender,
                    AddressLine1 = Demographics.AddressLine1,
                    AddressLine2 = Demographics.AddressLine2,
                    City = Demographics.City,
                    StateProvince = Demographics.StateProvince,
                    PostalCode = Demographics.PostalCode,
                    CountryCode = Demographics.CountryCode,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };

                Db.ContractorRequests.Add(request);
                Db.ContractorPeople.Add(person);
                await Db.SaveChangesAsync();

                // Store the generated GUID for later reference (draft id)
                SavedRequestId = request.RequestId;
            }
            else
            {
                var existingRequest = await Db.ContractorRequests.FirstOrDefaultAsync(r => r.RequestId == SavedRequestId);
                var existingPerson = await Db.ContractorPeople.FirstOrDefaultAsync(p => p.RequestId == SavedRequestId);

                if (existingPerson is not null)
                {
                    existingPerson.FirstName = Demographics.FirstName;
                    existingPerson.PreferredFirstName = Demographics.PreferredFirstName;
                    existingPerson.LastName = Demographics.LastName;
                    existingPerson.PreferredLastName = Demographics.PreferredLastName;
                    existingPerson.PersonalEmail = Demographics.PersonalEmail;
                    existingPerson.CellPhone = Demographics.CellPhone;
                    existingPerson.DateOfBirth = Demographics.DateOfBirth;
                    existingPerson.Gender = Demographics.Gender;
                    existingPerson.AddressLine1 = Demographics.AddressLine1;
                    existingPerson.AddressLine2 = Demographics.AddressLine2;
                    existingPerson.City = Demographics.City;
                    existingPerson.StateProvince = Demographics.StateProvince;
                    existingPerson.PostalCode = Demographics.PostalCode;
                    existingPerson.CountryCode = Demographics.CountryCode;
                    existingPerson.UpdatedAt = DateTime.UtcNow;
                }

                if (existingRequest is not null)
                {
                    // existingRequest.UpdatedAt = DateTime.UtcNow;
                }

                await Db.SaveChangesAsync();
            }

            return true;
        }
        catch (Exception ex)
        {
            SubmitError = "Unable to save demographics. " + ex.Message;
            return false;
        }
        finally
        {
            StateHasChanged();
        }
    }

    async Task<bool> SaveJobAndDates()
    {
        SubmitError = null;

        try
        {
            if (SavedRequestId == Guid.Empty)
            {
                SubmitError = "No saved request id available to update.";
                return false;
            }

            var existing = await Db.ContractorPeople.FirstOrDefaultAsync(p => p.RequestId == SavedRequestId);

            if (existing != null)
            {
                existing.AgencyName = JobInfo.AgencyName;
                existing.JobTitle = JobInfo.JobTitle;
                existing.JobCode = JobInfo.JobCode;
                existing.Department = JobInfo.Department;
                existing.StartDate = JobInfo.StartDate;
                existing.PriorEmployeeFlag = JobInfo.PriorEmployeeFlag;
                existing.ExternalEmployeeId = JobInfo.ExternalEmployeeId;
                existing.UpdatedAt = DateTime.UtcNow;

                await Db.SaveChangesAsync();
            }
            else
            {
                var person = new ContractorPerson
                {
                    RequestId = SavedRequestId,
                    AgencyName = JobInfo.AgencyName,
                    JobTitle = JobInfo.JobTitle,
                    JobCode = JobInfo.JobCode,
                    Department = JobInfo.Department,
                    StartDate = JobInfo.StartDate,
                    PriorEmployeeFlag = JobInfo.PriorEmployeeFlag,
                    ExternalEmployeeId = JobInfo.ExternalEmployeeId,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                Db.ContractorPeople.Add(person);
                await Db.SaveChangesAsync();
            }

            return true;
        }
        catch (Exception ex)
        {
            SubmitError = "Unable to save job/dates. " + ex.Message;
            return false;
        }
        finally
        {
            StateHasChanged();
        }
    }

    async Task<bool> SaveAccessTargets()
    {
        SubmitError = null;

        // Require at least one selected target before attempting DB work
        if (AccessInfo?.RequestedTargets == null || !AccessInfo.RequestedTargets.Any())
        {
            SubmitError = "Please select at least one access target.";
            try
            {
                if (JS is not null)
                {
                    await JS.InvokeVoidAsync("alert", SubmitError);
                }
            }
            catch
            {
                // ignore JS interop failures; SubmitError will still render on the page
            }

            StateHasChanged();
            return false;
        }

        try
        {
            if (SavedRequestId == Guid.Empty)
            {
                SubmitError = "No saved request id available to update.";
                return false;
            }

            var existingList = await Db.ContractorAccessRequest
                                       .Where(p => p.RequestId == SavedRequestId)
                                       .ToListAsync();

            if (existingList.Any())
            {
                Db.ContractorAccessRequest.RemoveRange(existingList);
                await Db.SaveChangesAsync();
            }

            foreach (var target in AccessInfo.RequestedTargets)
            {
                var access = new ContractorAccessRequest
                {
                    AccessRequestId = Guid.NewGuid(),
                    RequestId = SavedRequestId,
                    TargetId = target.TargetId,
                    Environment = "Prod",
                    CreatedAt = DateTime.UtcNow
                };

                Db.ContractorAccessRequest.Add(access);
            }

            await Db.SaveChangesAsync();
            return true;
        }
        catch (Exception ex)
        {
            SubmitError = "Unable to save access targets. " + ex.Message;
            return false;
        }
        finally
        {
            StateHasChanged();
        }
    }

    async Task<bool> SaveHardware()
    {
        SubmitError = null;

        try
        {
            if (SavedRequestId == Guid.Empty)
            {
                SubmitError = "No saved request id available to update.";
                return false;
            }

            var existing = await Db.ContractorHardwareRequest.FirstOrDefaultAsync(p => p.RequestId == SavedRequestId);

            if (existing != null)
            {
                existing.NeedsLaptop = Hardware.NeedsLaptop;
                existing.NeedsDock = Hardware.NeedsDock;
                existing.MonitorCount = Hardware.MonitorCount;
                existing.NeedsHeadset = Hardware.NeedsHeadset;
                existing.NeedsHotspot = Hardware.NeedsHotspot;
                existing.Notes = Hardware.Notes;
                existing.UpdatedAt = DateTime.UtcNow;
                await Db.SaveChangesAsync();
            }
            else
            {
                var hardware = new ContractorHardwareRequest
                {
                    RequestId = SavedRequestId,
                    NeedsLaptop = Hardware.NeedsLaptop,
                    NeedsDock = Hardware.NeedsDock,
                    MonitorCount = Hardware.MonitorCount,
                    NeedsHeadset = Hardware.NeedsHeadset,
                    NeedsHotspot = Hardware.NeedsHotspot,
                    Notes = Hardware.Notes,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };
                Db.ContractorHardwareRequest.Add(hardware);
                await Db.SaveChangesAsync();
            }

            return true;
        }
        catch (Exception ex)
        {
            SubmitError = "Unable to save hardware. " + ex.Message;
            return false;
        }
        finally
        {
            StateHasChanged();
        }
    }

    async Task<bool> SaveBadge()
    {
        SubmitError = null;

        // If badge is requested require RequestType
        if (Badge?.NeedsBadge == true && string.IsNullOrWhiteSpace(Badge.RequestType))
        {
            SubmitError = "Please select an Access Level / Request Type before continuing.";
            try
            {
                if (JS is not null)
                {
                    await JS.InvokeVoidAsync("alert", SubmitError);
                }
            }
            catch
            {
                // ignore JS interop errors
            }

            StateHasChanged();
            return false;
        }

        try
        {
            if (SavedRequestId == Guid.Empty)
            {
                SubmitError = "No saved request id available to update.";
                return false;
            }

            var existing = await Db.ContractorRequests.FirstOrDefaultAsync(p => p.RequestId == SavedRequestId);

            if (existing != null)
            {
                existing.PrimaryFacility = Badge.PrimaryFacility;
                existing.RequestType = Badge.RequestType;
                await Db.SaveChangesAsync();
            }
            else
            {
                var request = new ContractorRequest
                {
                    RequestId = SavedRequestId,
                    PrimaryFacility = Badge.PrimaryFacility,
                    RequestType = Badge.RequestType,
                    CreatedAt = DateTime.UtcNow,
                };
                Db.ContractorRequests.Add(request);
                await Db.SaveChangesAsync();
            }

            return true;
        }
        catch (Exception ex)
        {
            SubmitError = "Unable to save badge. " + ex.Message;
            return false;
        }
        finally
        {
            StateHasChanged();
        }
    }

    public class DemographicsModel : IValidatableObject
    {
        [Required(ErrorMessage = "First name is required.")]
        [StringLength(100, ErrorMessage = "First name must be at most 100 characters.")]
        [Display(Name = "First Name")]
        public string FirstName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Last name is required.")]
        [StringLength(100, ErrorMessage = "Last name must be at most 100 characters.")]
        [Display(Name = "Last Name")]
        public string LastName { get; set; } = string.Empty;

        [StringLength(100, ErrorMessage = "Preferred first name must be at most 100 characters.")]
        [Display(Name = "Preferred First Name")]
        public string PreferredFirstName { get; set; } = string.Empty;

        [StringLength(100, ErrorMessage = "Preferred last name must be at most 100 characters.")]
        [Display(Name = "Preferred Last Name")]
        public string PreferredLastName { get; set; } = string.Empty;

        [Required(ErrorMessage = "Personal email is required.")]
        [EmailAddress(ErrorMessage = "Personal email is not a valid email address.")]
        [StringLength(254, ErrorMessage = "Email must be at most 254 characters.")]
        [Display(Name = "Personal Email")]
        public string PersonalEmail { get; set; } = string.Empty;

        [RegularExpression(@"^[\d\+\-\s\(\)]{7,20}$", ErrorMessage = "Cell phone must contain 7-20 characters and may include digits, spaces, +, -, ().")]
        [Display(Name = "Cell Phone")]
        public string CellPhone { get; set; } = string.Empty;

        [Required(ErrorMessage = "Date of birth is required.")]
        [DataType(DataType.Date)]
        [Display(Name = "Date of Birth")]
        public DateTime DateOfBirth { get; set; } = DateTime.Today;

        [StringLength(20, ErrorMessage = "Gender must be at most 20 characters.")]
        public string Gender { get; set; } = string.Empty;

        [StringLength(200, ErrorMessage = "Address Line 1 must be at most 200 characters.")]
        public string AddressLine1 { get; set; } = string.Empty;

        [StringLength(200, ErrorMessage = "Address Line 2 must be at most 200 characters.")]
        public string AddressLine2 { get; set; } = string.Empty;

        [Required(ErrorMessage = "City is required.")]
        [StringLength(100, ErrorMessage = "City must be at most 100 characters.")]
        public string City { get; set; } = string.Empty;

        [Required(ErrorMessage = "State/Province is required.")]
        [StringLength(100, ErrorMessage = "State/Province must be at most 100 characters.")]
        public string StateProvince { get; set; } = string.Empty;

        [StringLength(10, ErrorMessage = "Postal code must be at most 10 characters.")]
        [RegularExpression(@"^[A-Za-z0-9\-\s]{3,10}$", ErrorMessage = "Postal code format is invalid.")]
        public string PostalCode { get; set; } = string.Empty;

        [Required(ErrorMessage = "Country code is required.")]
        [RegularExpression(@"^[A-Za-z]{2}$", ErrorMessage = "Country code must be 2 letters (ISO 3166-1 alpha-2).")]
        [Display(Name = "Country Code")]
        public string CountryCode { get; set; } = string.Empty;

        [StringLength(100, ErrorMessage = "Identity must be at most 100 characters.")]
        public string Identity { get; set; } = string.Empty;

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            var results = new List<ValidationResult>();

            // Date of birth must not be in the future
            if (DateOfBirth > DateTime.Today)
            {
                results.Add(new ValidationResult("Date of birth cannot be in the future.", new[] { nameof(DateOfBirth) }));
            }

            return results;
        }
    }

    public class JobModel
    {
        public string AgencyName { get; set; } = string.Empty;
        public string JobTitle { get; set; } = string.Empty;
        public string JobCode { get; set; } = string.Empty;
        public string Department { get; set; } = string.Empty;
        public string ExternalEmployeeId { get; set; } = string.Empty;
        public bool PriorEmployeeFlag { get; set; } = false;
        public DateTime StartDate { get; set; } = DateTime.Today;
    }

    public class AccessModel
    {
        public List<RequestTargetModel> RequestedTargets { get; set; } = new();
    }

    public class RequestTargetModel
    {
        public Guid AccessRequestId { get; set; }
        public Guid RequestId { get; set; }
        public Guid TargetId { get; set; }
        public string Environment { get; set; }
        public string ChangeType { get; set; }
        public string MirrorUserUpn { get; set; }
        public string DetailJson { get; set; }
        public DateTime CreatedAt { get; set; }
        public string CreatedByUpn { get; set; }
    }

    public class HardwareModel
    {
        public bool NeedsLaptop { get; set; } = true;
        public bool NeedsDock { get; set; } = true;
        public int MonitorCount { get; set; } = 2;
        public bool NeedsHeadset { get; set; } = true;
        public bool NeedsHotspot { get; set; } = true;
        public string Notes { get; set; } = string.Empty;
    }

    public class BadgeModel : IValidatableObject
    {
        public bool NeedsBadge { get; set; } = true;
        public string PrimaryFacility { get; set; } = string.Empty;
        [Required(ErrorMessage = "Request Type is required.")]
        public string RequestType { get; set; } = string.Empty;

        public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
        {
            var results = new List<ValidationResult>();
            return results;
        }
    }
}
