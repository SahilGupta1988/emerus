@using Emerus.ETM.Admin.Data
@using Emerus.ETM.Admin.Pages
@using System.Linq
@using System.Data
@using System.Data.Common
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components
@using static Emerus.ETM.Admin.Pages.AccessStep.AccessStep
@inject AppDbContext Db

<div class="card-section">
    <div class="d-flex justify-content-between align-items-start mb-2">
        <div>
            <h5 class="mb-0">Review</h5>
            <p class="text-muted mb-0">Confirm that the information below is correct before submitting.</p>
        </div>
        @if (OnEditStep.HasDelegate)
        {
            <div>
                <small class="text-muted">Need changes? <button class="btn btn-link btn-sm p-0" @onclick="(() => OnEditStep.InvokeAsync(0))">Jump to step</button></small>
            </div>
        }
    </div>

    <div class="row g-3">
        <!-- Demographics -->
        <div class="col-12 col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Demographics</strong>
                    @if (OnEditStep.HasDelegate)
                    {
                        <button class="btn btn-sm btn-outline-primary" @onclick="(() => OnEditStep.InvokeAsync(0))" aria-label="Edit demographics">Edit</button>
                    }
                </div>
                <div class="card-body">
                    <h6 class="mb-1">@Demographics.PreferredFirstName @Demographics.PreferredLastName</h6>
                    <div class="text-muted mb-2">(@Demographics.FirstName @Demographics.LastName)</div>

                    <dl class="row mb-0">
                        <dt class="col-4 text-muted">Email</dt>
                        <dd class="col-8">@Demographics.PersonalEmail</dd>

                        <dt class="col-4 text-muted">Phone</dt>
                        <dd class="col-8">@Demographics.CellPhone</dd>

                        <dt class="col-4 text-muted">DOB</dt>
                        <dd class="col-8">@((Demographics.DateOfBirth is DateTime dt) ? dt.ToShortDateString() : "-")</dd>

                        <dt class="col-4 text-muted">Gender</dt>
                        <dd class="col-8">@Demographics.Gender @if(!string.IsNullOrWhiteSpace(Demographics.Identity)){
                        <span class="text-muted"> - @Demographics.Identity</span>
                                                }
</dd>

                        <dt class="col-4 text-muted">Address</dt>
                        <dd class="col-8">
                            <div>@Demographics.AddressLine1</div>
                            @if (!string.IsNullOrWhiteSpace(Demographics.AddressLine2))
                            {
                                <div class="text-muted">@Demographics.AddressLine2</div>
                            }
                            <div class="text-muted">@Demographics.City, @Demographics.StateProvince @Demographics.PostalCode</div>
                            <div class="text-muted">@Demographics.CountryCode</div>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Job & Dates -->
        <div class="col-12 col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Job & Dates</strong>
                    @if (OnEditStep.HasDelegate)
                    {
                        <button class="btn btn-sm btn-outline-primary" @onclick="(() => OnEditStep.InvokeAsync(1))" aria-label="Edit job">Edit</button>
                    }
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-4 text-muted">Job title</dt>
                        <dd class="col-8">@JobInfo.JobTitle</dd>

                        <dt class="col-4 text-muted">Department</dt>
                        <dd class="col-8">@JobInfo.Department</dd>

                        <dt class="col-4 text-muted">Agency / Job code</dt>
                        <dd class="col-8">@JobInfo.AgencyName @if(!string.IsNullOrWhiteSpace(JobInfo.JobCode)){
                        <span class="text-muted"> - @JobInfo.JobCode</span>
                                                }
</dd>

                        <dt class="col-4 text-muted">External ID</dt>
                        <dd class="col-8">@JobInfo.ExternalEmployeeId</dd>

                        <dt class="col-4 text-muted">Prior employee</dt>
                        <dd class="col-8">
                            @if (JobInfo.PriorEmployeeFlag)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        </dd>

                        <dt class="col-4 text-muted">Start date</dt>
                        <dd class="col-8">@((JobInfo.StartDate is DateTime sd) ? sd.ToShortDateString() : "-")</dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Access Requests -->
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Access Requests</strong>
                    @if (OnEditStep.HasDelegate)
                    {
                        <button class="btn btn-sm btn-outline-primary" @onclick="(() => OnEditStep.InvokeAsync(2))" aria-label="Edit access">Edit</button>
                    }
                </div>
                <div class="card-body">
                    @if (AccessInfo?.RequestedTargets is null || !AccessInfo.RequestedTargets.Any())
                    {
                        <p class="text-muted mb-0">No access requested.</p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-sm mb-0 align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Target</th>
                                        <th>Environment</th>
                                        <th class="text-end">Requested</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var rt in AccessInfo.RequestedTargets)
                                    {
                                        var displayname = TargetCatalog?.FirstOrDefault(t => t.TargetId == rt.TargetId)?.DisplayName;
                                        <tr>
                                            <td>@(displayname ?? rt.TargetId.ToString())</td>
                                            <td>@(string.IsNullOrWhiteSpace(rt.Environment) ? "-" : rt.Environment)</td>
                                            <td class="text-end"><small class="text-muted">@rt.CreatedAt.ToLocalTime().ToString("g")</small></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Hardware -->
        <div class="col-12 col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Hardware</strong>
                    @if (OnEditStep.HasDelegate)
                    {
                        <button class="btn btn-sm btn-outline-primary" @onclick="(() => OnEditStep.InvokeAsync(3))" aria-label="Edit hardware">Edit</button>
                    }
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-4 text-muted">Laptop</dt>
                        <dd class="col-8">
                            @if (Hardware.NeedsLaptop)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        </dd>

                        <dt class="col-4 text-muted">Dock</dt>
                        <dd class="col-8">
                            @if (Hardware.NeedsDock)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        </dd>

                        <dt class="col-4 text-muted">Monitors</dt>
                        <dd class="col-8">@Hardware.MonitorCount</dd>

                        <dt class="col-4 text-muted">Headset</dt>
                        <dd class="col-8">
                            @if (Hardware.NeedsHeadset)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        </dd>

                        <dt class="col-4 text-muted">Hotspot</dt>
                        <dd class="col-8">
                            @if (Hardware.NeedsHotspot)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        </dd>

                        <dt class="col-4 text-muted">Notes</dt>
                        <dd class="col-8">@(!string.IsNullOrWhiteSpace(Hardware.Notes) ? Hardware.Notes : "None")</dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Badge -->
        <div class="col-12 col-md-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Badge</strong>
                    @if (OnEditStep.HasDelegate)
                    {
                        <button class="btn btn-sm btn-outline-primary" @onclick="(() => OnEditStep.InvokeAsync(4))" aria-label="Edit badge">Edit</button>
                    }
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-4 text-muted">Requested</dt>
                        <dd class="col-8">
                            @if (Badge.NeedsBadge)
                            {
                                <span class="badge bg-success">Yes</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">No</span>
                            }
                        </dd>

                        <dt class="col-4 text-muted">Facility</dt>
                        <dd class="col-8">@Badge.PrimaryFacility</dd>

                        <dt class="col-4 text-muted">Access level</dt>
                        <dd class="col-8">@Badge.RequestType</dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Compliance (documents) -->
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Compliance</strong>
                    @if (OnEditStep.HasDelegate)
                    {
                        <button class="btn btn-sm btn-outline-primary" @onclick="(() => OnEditStep.InvokeAsync(5))" aria-label="Edit compliance">Edit</button>
                    }
                </div>
                <div class="card-body">
                    @if (ComplianceDocuments is null || !ComplianceDocuments.Any())
                    {
                        <p class="text-muted mb-0">No documents uploaded.</p>
                    }
                    else
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var d in ComplianceDocuments)
                            {
                                <li class="list-group-item d-flex gap-3 align-items-center">
                                    <div class="file-meta d-flex align-items-center" style="min-width:0;">
                                        <span class="file-icon me-2">📄</span>
                                        <div class="text-truncate" style="max-width: 60vw;">
                                            <div class="fw-medium text-truncate">@d.FileName</div>
                                            <div class="text-muted small">@d.DocumentType - @d.UploadedByUpn - <small>@(d.UploadedAt.ToLocalTime().ToString("g"))</small></div>
                                        </div>
                                    </div>

                                    <div class="ms-auto d-flex align-items-center gap-2">
                                        <span class="badge bg-success">Uploaded</span>
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter]
    public OnboardingNew.DemographicsModel Demographics { get; set; } = default!;

    [Parameter]
    public OnboardingNew.JobModel JobInfo { get; set; } = default!;

    [Parameter]
    public OnboardingNew.AccessModel AccessInfo { get; set; } = default!;

    // Fixed: TargetCatalog is a collection of TargetCatalogModel (defined in AccessStep)
    [Parameter]
    public List<TargetCatalogModel> TargetCatalog { get; set; } = new();

    [Parameter]
    public OnboardingNew.HardwareModel Hardware { get; set; } = default!;

    [Parameter]
    public OnboardingNew.BadgeModel Badge { get; set; } = default!;

    // Optional callback so parent page (OnboardingNew) can jump to a step when user clicks Edit
    [Parameter]
    public EventCallback<int> OnEditStep { get; set; }

    // New: saved request id is used to load compliance documents for review
    [Parameter]
    public Guid SavedRequestId { get; set; }

    // Documents loaded from FileService
    private List<ContractorDocument> ComplianceDocuments { get; set; } = new();

    protected override async Task OnParametersSetAsync()
    {
        // If parent didn't provide a catalog, load from iam.TargetCatalog
        if (TargetCatalog == null || !TargetCatalog.Any())
        {
            var list = new List<TargetCatalogModel>();
            DbConnection? conn = null;
            try
            {
                conn = Db.Database.GetDbConnection();
                await conn.OpenAsync();

                using var cmd = conn.CreateCommand();
                cmd.CommandText = "SELECT TargetId, DisplayName FROM iam.TargetCatalog WHERE IsActive = 1 ORDER BY DisplayName";
                using var reader = await cmd.ExecuteReaderAsync();

                while (await reader.ReadAsync())
                {
                    var item = new TargetCatalogModel();

                    if (!reader.IsDBNull(0))
                    {
                        item.TargetId = reader.GetGuid(0);
                    }

                    if (!reader.IsDBNull(1))
                    {
                        item.DisplayName = reader.GetString(1);
                    }

                    list.Add(item);
                }

                TargetCatalog = list;
            }
            catch
            {
                // keep TargetCatalog empty on error to keep UI resilient
                TargetCatalog = new List<TargetCatalogModel>();
            }
            finally
            {
                if (conn is not null && conn.State == ConnectionState.Open)
                {
                    await conn.CloseAsync();
                }
            }
        }

        // Load compliance documents for the provided SavedRequestId (if available)
        try
        {
            if (SavedRequestId != Guid.Empty)
            {
                // _fileService is injected via _Imports.razor as IFileService _fileService
                ComplianceDocuments = await _fileService.GetDocumentByRequestIdAsync(SavedRequestId).ConfigureAwait(false);
            }
            else
            {
                ComplianceDocuments = new List<ContractorDocument>();
            }
        }
        catch
        {
            ComplianceDocuments = new List<ContractorDocument>();
        }
    }
}