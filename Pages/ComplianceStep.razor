
@attribute [Authorize(Roles = "Approver,Requestor")]

<div class="card-section">
    <h5>Compliance</h5>
    <p class="text-muted">Upload required network usage, identity verification, and confidentiality forms. This is a mock layout.</p>

    <div class="mb-3">
        <label class="form-label">Upload Documents</label>
        <InputFile OnChange="OnFileChange" />
    </div>

    <ul class="list-group">
        @foreach (var d in Documents)
        {
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span>@d</span>
                <span class="badge bg-success">Uploaded</span>
            </li>
        }
    </ul>
</div>

@code {
    // private List<string> Documents = new();

    // private void OnFileChange(InputFileChangeEventArgs e)
    // {
    //     foreach (var file in e.GetMultipleFiles())
    //     {
    //         Documents.Add(file.Name);
    //     }
    // }


    private List<string> Documents = new();
    private Guid ContractorId = Guid.Parse("11111111-1111-1111-1111-111111111111");

    private async Task OnFileChange(InputFileChangeEventArgs e)
    {
        foreach (var file in e.GetMultipleFiles())
        {
            try
            {
                await using var stream = file.OpenReadStream(10 * 1024 * 1024);

                var dto = new FileUploadDto
                {
                    FileStream = stream,
                    FileName = file.Name,
                    DocumentType = GetDocumentType(file.Name),
                    ContractorId = ContractorId
                };

                await _fileService.UploadAsync(dto, "system").ConfigureAwait(false);
                Documents.Add(file.Name);
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine(
                    $"Upload failed for {file.Name}: {ex.Message}");
            }
        }
    }

    private string GetDocumentType(string fileName)
    {
        fileName = fileName.ToLowerInvariant();

        if (fileName.Contains("nupc"))
            return "NUPC";
        if (fileName.Contains("iaa"))
            return "IAA";
        if (fileName.EndsWith(".pdf"))
            return "PDF";

        return "Other";
    }
}
